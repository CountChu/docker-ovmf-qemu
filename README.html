<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>@font-face {
  font-family: octicons-link;
  src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAZwABAAAAAACFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEU0lHAAAGaAAAAAgAAAAIAAAAAUdTVUIAAAZcAAAACgAAAAoAAQAAT1MvMgAAAyQAAABJAAAAYFYEU3RjbWFwAAADcAAAAEUAAACAAJThvmN2dCAAAATkAAAABAAAAAQAAAAAZnBnbQAAA7gAAACyAAABCUM+8IhnYXNwAAAGTAAAABAAAAAQABoAI2dseWYAAAFsAAABPAAAAZwcEq9taGVhZAAAAsgAAAA0AAAANgh4a91oaGVhAAADCAAAABoAAAAkCA8DRGhtdHgAAAL8AAAADAAAAAwGAACfbG9jYQAAAsAAAAAIAAAACABiATBtYXhwAAACqAAAABgAAAAgAA8ASm5hbWUAAAToAAABQgAAAlXu73sOcG9zdAAABiwAAAAeAAAAME3QpOBwcmVwAAAEbAAAAHYAAAB/aFGpk3jaTY6xa8JAGMW/O62BDi0tJLYQincXEypYIiGJjSgHniQ6umTsUEyLm5BV6NDBP8Tpts6F0v+k/0an2i+itHDw3v2+9+DBKTzsJNnWJNTgHEy4BgG3EMI9DCEDOGEXzDADU5hBKMIgNPZqoD3SilVaXZCER3/I7AtxEJLtzzuZfI+VVkprxTlXShWKb3TBecG11rwoNlmmn1P2WYcJczl32etSpKnziC7lQyWe1smVPy/Lt7Kc+0vWY/gAgIIEqAN9we0pwKXreiMasxvabDQMM4riO+qxM2ogwDGOZTXxwxDiycQIcoYFBLj5K3EIaSctAq2kTYiw+ymhce7vwM9jSqO8JyVd5RH9gyTt2+J/yUmYlIR0s04n6+7Vm1ozezUeLEaUjhaDSuXHwVRgvLJn1tQ7xiuVv/ocTRF42mNgZGBgYGbwZOBiAAFGJBIMAAizAFoAAABiAGIAznjaY2BkYGAA4in8zwXi+W2+MjCzMIDApSwvXzC97Z4Ig8N/BxYGZgcgl52BCSQKAA3jCV8CAABfAAAAAAQAAEB42mNgZGBg4f3vACQZQABIMjKgAmYAKEgBXgAAeNpjYGY6wTiBgZWBg2kmUxoDA4MPhGZMYzBi1AHygVLYQUCaawqDA4PChxhmh/8ODDEsvAwHgMKMIDnGL0x7gJQCAwMAJd4MFwAAAHjaY2BgYGaA4DAGRgYQkAHyGMF8NgYrIM3JIAGVYYDT+AEjAwuDFpBmA9KMDEwMCh9i/v8H8sH0/4dQc1iAmAkALaUKLgAAAHjaTY9LDsIgEIbtgqHUPpDi3gPoBVyRTmTddOmqTXThEXqrob2gQ1FjwpDvfwCBdmdXC5AVKFu3e5MfNFJ29KTQT48Ob9/lqYwOGZxeUelN2U2R6+cArgtCJpauW7UQBqnFkUsjAY/kOU1cP+DAgvxwn1chZDwUbd6CFimGXwzwF6tPbFIcjEl+vvmM/byA48e6tWrKArm4ZJlCbdsrxksL1AwWn/yBSJKpYbq8AXaaTb8AAHja28jAwOC00ZrBeQNDQOWO//sdBBgYGRiYWYAEELEwMTE4uzo5Zzo5b2BxdnFOcALxNjA6b2ByTswC8jYwg0VlNuoCTWAMqNzMzsoK1rEhNqByEyerg5PMJlYuVueETKcd/89uBpnpvIEVomeHLoMsAAe1Id4AAAAAAAB42oWQT07CQBTGv0JBhagk7HQzKxca2sJCE1hDt4QF+9JOS0nbaaYDCQfwCJ7Au3AHj+LO13FMmm6cl7785vven0kBjHCBhfpYuNa5Ph1c0e2Xu3jEvWG7UdPDLZ4N92nOm+EBXuAbHmIMSRMs+4aUEd4Nd3CHD8NdvOLTsA2GL8M9PODbcL+hD7C1xoaHeLJSEao0FEW14ckxC+TU8TxvsY6X0eLPmRhry2WVioLpkrbp84LLQPGI7c6sOiUzpWIWS5GzlSgUzzLBSikOPFTOXqly7rqx0Z1Q5BAIoZBSFihQYQOOBEdkCOgXTOHA07HAGjGWiIjaPZNW13/+lm6S9FT7rLHFJ6fQbkATOG1j2OFMucKJJsxIVfQORl+9Jyda6Sl1dUYhSCm1dyClfoeDve4qMYdLEbfqHf3O/AdDumsjAAB42mNgYoAAZQYjBmyAGYQZmdhL8zLdDEydARfoAqIAAAABAAMABwAKABMAB///AA8AAQAAAAAAAAAAAAAAAAABAAAAAA==) format('woff');
}

@media (prefers-color-scheme: dark) {
  body,
  [data-theme="dark"] {
    /*dark*/
    color-scheme: dark;
    --color-prettylights-syntax-comment: #8b949e;
    --color-prettylights-syntax-constant: #79c0ff;
    --color-prettylights-syntax-entity: #d2a8ff;
    --color-prettylights-syntax-storage-modifier-import: #c9d1d9;
    --color-prettylights-syntax-entity-tag: #7ee787;
    --color-prettylights-syntax-keyword: #ff7b72;
    --color-prettylights-syntax-string: #a5d6ff;
    --color-prettylights-syntax-variable: #ffa657;
    --color-prettylights-syntax-brackethighlighter-unmatched: #f85149;
    --color-prettylights-syntax-invalid-illegal-text: #f0f6fc;
    --color-prettylights-syntax-invalid-illegal-bg: #8e1519;
    --color-prettylights-syntax-carriage-return-text: #f0f6fc;
    --color-prettylights-syntax-carriage-return-bg: #b62324;
    --color-prettylights-syntax-string-regexp: #7ee787;
    --color-prettylights-syntax-markup-list: #f2cc60;
    --color-prettylights-syntax-markup-heading: #1f6feb;
    --color-prettylights-syntax-markup-italic: #c9d1d9;
    --color-prettylights-syntax-markup-bold: #c9d1d9;
    --color-prettylights-syntax-markup-deleted-text: #ffdcd7;
    --color-prettylights-syntax-markup-deleted-bg: #67060c;
    --color-prettylights-syntax-markup-inserted-text: #aff5b4;
    --color-prettylights-syntax-markup-inserted-bg: #033a16;
    --color-prettylights-syntax-markup-changed-text: #ffdfb6;
    --color-prettylights-syntax-markup-changed-bg: #5a1e02;
    --color-prettylights-syntax-markup-ignored-text: #c9d1d9;
    --color-prettylights-syntax-markup-ignored-bg: #1158c7;
    --color-prettylights-syntax-meta-diff-range: #d2a8ff;
    --color-prettylights-syntax-brackethighlighter-angle: #8b949e;
    --color-prettylights-syntax-sublimelinter-gutter-mark: #484f58;
    --color-prettylights-syntax-constant-other-reference-link: #a5d6ff;
    --color-fg-default: #e6edf3;
    --color-fg-muted: #848d97;
    --color-fg-subtle: #6e7681;
    --color-canvas-default: #0d1117;
    --color-canvas-subtle: #161b22;
    --color-border-default: #30363d;
    --color-border-muted: #21262d;
    --color-neutral-muted: rgba(110,118,129,0.4);
    --color-accent-fg: #2f81f7;
    --color-accent-emphasis: #1f6feb;
    --color-success-fg: #3fb950;
    --color-success-emphasis: #238636;
    --color-attention-fg: #d29922;
    --color-attention-emphasis: #9e6a03;
    --color-attention-subtle: rgba(187,128,9,0.15);
    --color-danger-fg: #f85149;
    --color-danger-emphasis: #da3633;
    --color-done-fg: #a371f7;
    --color-done-emphasis: #8957e5;
  }
}

@media (prefers-color-scheme: light) {
  body,
  [data-theme="light"] {
    /*light*/
    color-scheme: light;
    --color-prettylights-syntax-comment: #57606a;
    --color-prettylights-syntax-constant: #0550ae;
    --color-prettylights-syntax-entity: #6639ba;
    --color-prettylights-syntax-storage-modifier-import: #24292f;
    --color-prettylights-syntax-entity-tag: #116329;
    --color-prettylights-syntax-keyword: #cf222e;
    --color-prettylights-syntax-string: #0a3069;
    --color-prettylights-syntax-variable: #953800;
    --color-prettylights-syntax-brackethighlighter-unmatched: #82071e;
    --color-prettylights-syntax-invalid-illegal-text: #f6f8fa;
    --color-prettylights-syntax-invalid-illegal-bg: #82071e;
    --color-prettylights-syntax-carriage-return-text: #f6f8fa;
    --color-prettylights-syntax-carriage-return-bg: #cf222e;
    --color-prettylights-syntax-string-regexp: #116329;
    --color-prettylights-syntax-markup-list: #3b2300;
    --color-prettylights-syntax-markup-heading: #0550ae;
    --color-prettylights-syntax-markup-italic: #24292f;
    --color-prettylights-syntax-markup-bold: #24292f;
    --color-prettylights-syntax-markup-deleted-text: #82071e;
    --color-prettylights-syntax-markup-deleted-bg: #ffebe9;
    --color-prettylights-syntax-markup-inserted-text: #116329;
    --color-prettylights-syntax-markup-inserted-bg: #dafbe1;
    --color-prettylights-syntax-markup-changed-text: #953800;
    --color-prettylights-syntax-markup-changed-bg: #ffd8b5;
    --color-prettylights-syntax-markup-ignored-text: #eaeef2;
    --color-prettylights-syntax-markup-ignored-bg: #0550ae;
    --color-prettylights-syntax-meta-diff-range: #8250df;
    --color-prettylights-syntax-brackethighlighter-angle: #57606a;
    --color-prettylights-syntax-sublimelinter-gutter-mark: #8c959f;
    --color-prettylights-syntax-constant-other-reference-link: #0a3069;
    --color-fg-default: #1F2328;
    --color-fg-muted: #656d76;
    --color-fg-subtle: #6e7781;
    --color-canvas-default: #ffffff;
    --color-canvas-subtle: #f6f8fa;
    --color-border-default: #d0d7de;
    --color-border-muted: hsla(210,18%,87%,1);
    --color-neutral-muted: rgba(175,184,193,0.2);
    --color-accent-fg: #0969da;
    --color-accent-emphasis: #0969da;
    --color-success-fg: #1a7f37;
    --color-success-emphasis: #1f883d;
    --color-attention-fg: #9a6700;
    --color-attention-emphasis: #9a6700;
    --color-attention-subtle: #fff8c5;
    --color-danger-fg: #d1242f;
    --color-danger-emphasis: #cf222e;
    --color-done-fg: #8250df;
    --color-done-emphasis: #8250df;
  }
}

body {
    width: 980px;
    margin-right: auto;
    margin-left: auto;
    background-color: var(--color-canvas-default);
}

.markdown-body .octicon-link:before {
  font: normal normal normal 16px/1 octicons-link;
  display: inline-block;
  text-decoration: none;
  text-rendering: auto;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  content: '\f05c';
  vertical-align: middle;
}

.markdown-body {
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  margin: 0;
  color: var(--color-fg-default);
  background-color: var(--color-canvas-default);
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
  font-size: 16px;
  line-height: 1.5;
  word-wrap: break-word;
}

.markdown-body .octicon {
  display: inline-block;
  fill: currentColor;
  vertical-align: text-bottom;
}

.markdown-body h1:hover .anchor .octicon-link:before,
.markdown-body h2:hover .anchor .octicon-link:before,
.markdown-body h3:hover .anchor .octicon-link:before,
.markdown-body h4:hover .anchor .octicon-link:before,
.markdown-body h5:hover .anchor .octicon-link:before,
.markdown-body h6:hover .anchor .octicon-link:before {
  width: 16px;
  height: 16px;
  content: ' ';
  display: inline-block;
  background-color: currentColor;
  -webkit-mask-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>");
  mask-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>");
}

.markdown-body details,
.markdown-body figcaption,
.markdown-body figure {
  display: block;
}

.markdown-body summary {
  display: list-item;
}

.markdown-body [hidden] {
  display: none !important;
}

.markdown-body a {
  background-color: transparent;
  color: var(--color-accent-fg);
  text-decoration: none;
}

.markdown-body abbr[title] {
  border-bottom: none;
  -webkit-text-decoration: underline dotted;
  text-decoration: underline dotted;
}

.markdown-body b,
.markdown-body strong {
  font-weight: var(--base-text-weight-semibold, 600);
}

.markdown-body dfn {
  font-style: italic;
}

.markdown-body h1 {
  margin: .67em 0;
  font-weight: var(--base-text-weight-semibold, 600);
  padding-bottom: .3em;
  font-size: 2em;
  border-bottom: 1px solid var(--color-border-muted);
}

.markdown-body mark {
  background-color: var(--color-attention-subtle);
  color: var(--color-fg-default);
}

.markdown-body small {
  font-size: 90%;
}

.markdown-body sub,
.markdown-body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}

.markdown-body sub {
  bottom: -0.25em;
}

.markdown-body sup {
  top: -0.5em;
}

.markdown-body img {
  border-style: none;
  max-width: 100%;
  box-sizing: content-box;
  background-color: var(--color-canvas-default);
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre,
.markdown-body samp {
  font-family: monospace;
  font-size: 1em;
}

.markdown-body figure {
  margin: 1em 40px;
}

.markdown-body hr {
  box-sizing: content-box;
  overflow: hidden;
  background: transparent;
  border-bottom: 1px solid var(--color-border-muted);
  height: .25em;
  padding: 0;
  margin: 24px 0;
  background-color: var(--color-border-default);
  border: 0;
}

.markdown-body input {
  font: inherit;
  margin: 0;
  overflow: visible;
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
}

.markdown-body [type=button],
.markdown-body [type=reset],
.markdown-body [type=submit] {
  -webkit-appearance: button;
  appearance: button;
}

.markdown-body [type=checkbox],
.markdown-body [type=radio] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body [type=number]::-webkit-inner-spin-button,
.markdown-body [type=number]::-webkit-outer-spin-button {
  height: auto;
}

.markdown-body [type=search]::-webkit-search-cancel-button,
.markdown-body [type=search]::-webkit-search-decoration {
  -webkit-appearance: none;
  appearance: none;
}

.markdown-body ::-webkit-input-placeholder {
  color: inherit;
  opacity: .54;
}

.markdown-body ::-webkit-file-upload-button {
  -webkit-appearance: button;
  appearance: button;
  font: inherit;
}

.markdown-body a:hover {
  text-decoration: underline;
}

.markdown-body ::placeholder {
  color: var(--color-fg-subtle);
  opacity: 1;
}

.markdown-body hr::before {
  display: table;
  content: "";
}

.markdown-body hr::after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body table {
  border-spacing: 0;
  border-collapse: collapse;
  display: block;
  width: max-content;
  max-width: 100%;
  overflow: auto;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body details summary {
  cursor: pointer;
}

.markdown-body details:not([open])>*:not(summary) {
  display: none !important;
}

.markdown-body a:focus,
.markdown-body [role=button]:focus,
.markdown-body input[type=radio]:focus,
.markdown-body input[type=checkbox]:focus {
  outline: 2px solid var(--color-accent-fg);
  outline-offset: -2px;
  box-shadow: none;
}

.markdown-body a:focus:not(:focus-visible),
.markdown-body [role=button]:focus:not(:focus-visible),
.markdown-body input[type=radio]:focus:not(:focus-visible),
.markdown-body input[type=checkbox]:focus:not(:focus-visible) {
  outline: solid 1px transparent;
}

.markdown-body a:focus-visible,
.markdown-body [role=button]:focus-visible,
.markdown-body input[type=radio]:focus-visible,
.markdown-body input[type=checkbox]:focus-visible {
  outline: 2px solid var(--color-accent-fg);
  outline-offset: -2px;
  box-shadow: none;
}

.markdown-body a:not([class]):focus,
.markdown-body a:not([class]):focus-visible,
.markdown-body input[type=radio]:focus,
.markdown-body input[type=radio]:focus-visible,
.markdown-body input[type=checkbox]:focus,
.markdown-body input[type=checkbox]:focus-visible {
  outline-offset: 0;
}

.markdown-body kbd {
  display: inline-block;
  padding: 3px 5px;
  font: 11px ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;
  line-height: 10px;
  color: var(--color-fg-default);
  vertical-align: middle;
  background-color: var(--color-canvas-subtle);
  border: solid 1px var(--color-neutral-muted);
  border-bottom-color: var(--color-neutral-muted);
  border-radius: 6px;
  box-shadow: inset 0 -1px 0 var(--color-neutral-muted);
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 24px;
  margin-bottom: 16px;
  font-weight: var(--base-text-weight-semibold, 600);
  line-height: 1.25;
}

.markdown-body h2 {
  font-weight: var(--base-text-weight-semibold, 600);
  padding-bottom: .3em;
  font-size: 1.5em;
  border-bottom: 1px solid var(--color-border-muted);
}

.markdown-body h3 {
  font-weight: var(--base-text-weight-semibold, 600);
  font-size: 1.25em;
}

.markdown-body h4 {
  font-weight: var(--base-text-weight-semibold, 600);
  font-size: 1em;
}

.markdown-body h5 {
  font-weight: var(--base-text-weight-semibold, 600);
  font-size: .875em;
}

.markdown-body h6 {
  font-weight: var(--base-text-weight-semibold, 600);
  font-size: .85em;
  color: var(--color-fg-muted);
}

.markdown-body p {
  margin-top: 0;
  margin-bottom: 10px;
}

.markdown-body blockquote {
  margin: 0;
  padding: 0 1em;
  color: var(--color-fg-muted);
  border-left: .25em solid var(--color-border-default);
}

.markdown-body ul,
.markdown-body ol {
  margin-top: 0;
  margin-bottom: 0;
  padding-left: 2em;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body tt,
.markdown-body code,
.markdown-body samp {
  font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
  font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;
  font-size: 12px;
  word-wrap: normal;
}

.markdown-body .octicon {
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-body input::-webkit-outer-spin-button,
.markdown-body input::-webkit-inner-spin-button {
  margin: 0;
  -webkit-appearance: none;
  appearance: none;
}

.markdown-body .mr-2 {
  margin-right: var(--base-size-8, 8px) !important;
}

.markdown-body::before {
  display: table;
  content: "";
}

.markdown-body::after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body a:not([href]) {
  color: inherit;
  text-decoration: none;
}

.markdown-body .absent {
  color: var(--color-danger-fg);
}

.markdown-body .anchor {
  float: left;
  padding-right: 4px;
  margin-left: -20px;
  line-height: 1;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre,
.markdown-body details {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  color: var(--color-fg-default);
  vertical-align: middle;
  visibility: hidden;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
  visibility: visible;
}

.markdown-body h1 tt,
.markdown-body h1 code,
.markdown-body h2 tt,
.markdown-body h2 code,
.markdown-body h3 tt,
.markdown-body h3 code,
.markdown-body h4 tt,
.markdown-body h4 code,
.markdown-body h5 tt,
.markdown-body h5 code,
.markdown-body h6 tt,
.markdown-body h6 code {
  padding: 0 .2em;
  font-size: inherit;
}

.markdown-body summary h1,
.markdown-body summary h2,
.markdown-body summary h3,
.markdown-body summary h4,
.markdown-body summary h5,
.markdown-body summary h6 {
  display: inline-block;
}

.markdown-body summary h1 .anchor,
.markdown-body summary h2 .anchor,
.markdown-body summary h3 .anchor,
.markdown-body summary h4 .anchor,
.markdown-body summary h5 .anchor,
.markdown-body summary h6 .anchor {
  margin-left: -40px;
}

.markdown-body summary h1,
.markdown-body summary h2 {
  padding-bottom: 0;
  border-bottom: 0;
}

.markdown-body ul.no-list,
.markdown-body ol.no-list {
  padding: 0;
  list-style-type: none;
}

.markdown-body ol[type="a s"] {
  list-style-type: lower-alpha;
}

.markdown-body ol[type="A s"] {
  list-style-type: upper-alpha;
}

.markdown-body ol[type="i s"] {
  list-style-type: lower-roman;
}

.markdown-body ol[type="I s"] {
  list-style-type: upper-roman;
}

.markdown-body ol[type="1"] {
  list-style-type: decimal;
}

.markdown-body div>ol:not([type]) {
  list-style-type: decimal;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body li+li {
  margin-top: .25em;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: var(--base-text-weight-semibold, 600);
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body table th {
  font-weight: var(--base-text-weight-semibold, 600);
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid var(--color-border-default);
}

.markdown-body table td>:last-child {
  margin-bottom: 0;
}

.markdown-body table tr {
  background-color: var(--color-canvas-default);
  border-top: 1px solid var(--color-border-muted);
}

.markdown-body table tr:nth-child(2n) {
  background-color: var(--color-canvas-subtle);
}

.markdown-body table img {
  background-color: transparent;
}

.markdown-body img[align=right] {
  padding-left: 20px;
}

.markdown-body img[align=left] {
  padding-right: 20px;
}

.markdown-body .emoji {
  max-width: none;
  vertical-align: text-top;
  background-color: transparent;
}

.markdown-body span.frame {
  display: block;
  overflow: hidden;
}

.markdown-body span.frame>span {
  display: block;
  float: left;
  width: auto;
  padding: 7px;
  margin: 13px 0 0;
  overflow: hidden;
  border: 1px solid var(--color-border-default);
}

.markdown-body span.frame span img {
  display: block;
  float: left;
}

.markdown-body span.frame span span {
  display: block;
  padding: 5px 0 0;
  clear: both;
  color: var(--color-fg-default);
}

.markdown-body span.align-center {
  display: block;
  overflow: hidden;
  clear: both;
}

.markdown-body span.align-center>span {
  display: block;
  margin: 13px auto 0;
  overflow: hidden;
  text-align: center;
}

.markdown-body span.align-center span img {
  margin: 0 auto;
  text-align: center;
}

.markdown-body span.align-right {
  display: block;
  overflow: hidden;
  clear: both;
}

.markdown-body span.align-right>span {
  display: block;
  margin: 13px 0 0;
  overflow: hidden;
  text-align: right;
}

.markdown-body span.align-right span img {
  margin: 0;
  text-align: right;
}

.markdown-body span.float-left {
  display: block;
  float: left;
  margin-right: 13px;
  overflow: hidden;
}

.markdown-body span.float-left span {
  margin: 13px 0 0;
}

.markdown-body span.float-right {
  display: block;
  float: right;
  margin-left: 13px;
  overflow: hidden;
}

.markdown-body span.float-right>span {
  display: block;
  margin: 13px auto 0;
  overflow: hidden;
  text-align: right;
}

.markdown-body code,
.markdown-body tt {
  padding: .2em .4em;
  margin: 0;
  font-size: 85%;
  white-space: break-spaces;
  background-color: var(--color-neutral-muted);
  border-radius: 6px;
}

.markdown-body code br,
.markdown-body tt br {
  display: none;
}

.markdown-body del code {
  text-decoration: inherit;
}

.markdown-body samp {
  font-size: 85%;
}

.markdown-body pre code {
  font-size: 100%;
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  color: var(--color-fg-default);
  background-color: var(--color-canvas-subtle);
  border-radius: 6px;
}

.markdown-body pre code,
.markdown-body pre tt {
  display: inline;
  max-width: auto;
  padding: 0;
  margin: 0;
  overflow: visible;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body .csv-data td,
.markdown-body .csv-data th {
  padding: 5px;
  overflow: hidden;
  font-size: 12px;
  line-height: 1;
  text-align: left;
  white-space: nowrap;
}

.markdown-body .csv-data .blob-num {
  padding: 10px 8px 9px;
  text-align: right;
  background: var(--color-canvas-default);
  border: 0;
}

.markdown-body .csv-data tr {
  border-top: 0;
}

.markdown-body .csv-data th {
  font-weight: var(--base-text-weight-semibold, 600);
  background: var(--color-canvas-subtle);
  border-top: 0;
}

.markdown-body [data-footnote-ref]::before {
  content: "[";
}

.markdown-body [data-footnote-ref]::after {
  content: "]";
}

.markdown-body .footnotes {
  font-size: 12px;
  color: var(--color-fg-muted);
  border-top: 1px solid var(--color-border-default);
}

.markdown-body .footnotes ol {
  padding-left: 16px;
}

.markdown-body .footnotes ol ul {
  display: inline-block;
  padding-left: 16px;
  margin-top: 16px;
}

.markdown-body .footnotes li {
  position: relative;
}

.markdown-body .footnotes li:target::before {
  position: absolute;
  top: -8px;
  right: -8px;
  bottom: -8px;
  left: -24px;
  pointer-events: none;
  content: "";
  border: 2px solid var(--color-accent-emphasis);
  border-radius: 6px;
}

.markdown-body .footnotes li:target {
  color: var(--color-fg-default);
}

.markdown-body .footnotes .data-footnote-backref g-emoji {
  font-family: monospace;
}

.markdown-body .pl-c {
  color: var(--color-prettylights-syntax-comment);
}

.markdown-body .pl-c1,
.markdown-body .pl-s .pl-v {
  color: var(--color-prettylights-syntax-constant);
}

.markdown-body .pl-e,
.markdown-body .pl-en {
  color: var(--color-prettylights-syntax-entity);
}

.markdown-body .pl-smi,
.markdown-body .pl-s .pl-s1 {
  color: var(--color-prettylights-syntax-storage-modifier-import);
}

.markdown-body .pl-ent {
  color: var(--color-prettylights-syntax-entity-tag);
}

.markdown-body .pl-k {
  color: var(--color-prettylights-syntax-keyword);
}

.markdown-body .pl-s,
.markdown-body .pl-pds,
.markdown-body .pl-s .pl-pse .pl-s1,
.markdown-body .pl-sr,
.markdown-body .pl-sr .pl-cce,
.markdown-body .pl-sr .pl-sre,
.markdown-body .pl-sr .pl-sra {
  color: var(--color-prettylights-syntax-string);
}

.markdown-body .pl-v,
.markdown-body .pl-smw {
  color: var(--color-prettylights-syntax-variable);
}

.markdown-body .pl-bu {
  color: var(--color-prettylights-syntax-brackethighlighter-unmatched);
}

.markdown-body .pl-ii {
  color: var(--color-prettylights-syntax-invalid-illegal-text);
  background-color: var(--color-prettylights-syntax-invalid-illegal-bg);
}

.markdown-body .pl-c2 {
  color: var(--color-prettylights-syntax-carriage-return-text);
  background-color: var(--color-prettylights-syntax-carriage-return-bg);
}

.markdown-body .pl-sr .pl-cce {
  font-weight: bold;
  color: var(--color-prettylights-syntax-string-regexp);
}

.markdown-body .pl-ml {
  color: var(--color-prettylights-syntax-markup-list);
}

.markdown-body .pl-mh,
.markdown-body .pl-mh .pl-en,
.markdown-body .pl-ms {
  font-weight: bold;
  color: var(--color-prettylights-syntax-markup-heading);
}

.markdown-body .pl-mi {
  font-style: italic;
  color: var(--color-prettylights-syntax-markup-italic);
}

.markdown-body .pl-mb {
  font-weight: bold;
  color: var(--color-prettylights-syntax-markup-bold);
}

.markdown-body .pl-md {
  color: var(--color-prettylights-syntax-markup-deleted-text);
  background-color: var(--color-prettylights-syntax-markup-deleted-bg);
}

.markdown-body .pl-mi1 {
  color: var(--color-prettylights-syntax-markup-inserted-text);
  background-color: var(--color-prettylights-syntax-markup-inserted-bg);
}

.markdown-body .pl-mc {
  color: var(--color-prettylights-syntax-markup-changed-text);
  background-color: var(--color-prettylights-syntax-markup-changed-bg);
}

.markdown-body .pl-mi2 {
  color: var(--color-prettylights-syntax-markup-ignored-text);
  background-color: var(--color-prettylights-syntax-markup-ignored-bg);
}

.markdown-body .pl-mdr {
  font-weight: bold;
  color: var(--color-prettylights-syntax-meta-diff-range);
}

.markdown-body .pl-ba {
  color: var(--color-prettylights-syntax-brackethighlighter-angle);
}

.markdown-body .pl-sg {
  color: var(--color-prettylights-syntax-sublimelinter-gutter-mark);
}

.markdown-body .pl-corl {
  text-decoration: underline;
  color: var(--color-prettylights-syntax-constant-other-reference-link);
}

.markdown-body g-emoji {
  display: inline-block;
  min-width: 1ch;
  font-family: "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
  font-size: 1em;
  font-style: normal !important;
  font-weight: var(--base-text-weight-normal, 400);
  line-height: 1;
  vertical-align: -0.075em;
}

.markdown-body g-emoji img {
  width: 1em;
  height: 1em;
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item label {
  font-weight: var(--base-text-weight-normal, 400);
}

.markdown-body .task-list-item.enabled label {
  cursor: pointer;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 4px;
}

.markdown-body .task-list-item .handle {
  display: none;
}

.markdown-body .task-list-item-checkbox {
  margin: 0 .2em .25em -1.4em;
  vertical-align: middle;
}

.markdown-body .contains-task-list:dir(rtl) .task-list-item-checkbox {
  margin: 0 -1.6em .25em .2em;
}

.markdown-body .contains-task-list {
  position: relative;
}

.markdown-body .contains-task-list:hover .task-list-item-convert-container,
.markdown-body .contains-task-list:focus-within .task-list-item-convert-container {
  display: block;
  width: auto;
  height: 24px;
  overflow: visible;
  clip: auto;
}

.markdown-body ::-webkit-calendar-picker-indicator {
  filter: invert(50%);
}

.markdown-body .markdown-alert {
  padding: var(--base-size-8, 8px) var(--base-size-16, 16px);
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid var(--color-border-default);
}

.markdown-body .markdown-alert>:first-child {
  margin-top: 0;
}

.markdown-body .markdown-alert>:last-child {
  margin-bottom: 0;
}

.markdown-body .markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: var(--base-text-weight-medium, 500);
  align-items: center;
  line-height: 1;
}

.markdown-body .markdown-alert.markdown-alert-note {
  border-left-color: var(--color-accent-emphasis);
}

.markdown-body .markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-accent-fg);
}

.markdown-body .markdown-alert.markdown-alert-important {
  border-left-color: var(--color-done-emphasis);
}

.markdown-body .markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-done-fg);
}

.markdown-body .markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-attention-emphasis);
}

.markdown-body .markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-attention-fg);
}

.markdown-body .markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-success-emphasis);
}

.markdown-body .markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-success-fg);
}

.markdown-body .markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-danger-emphasis);
}

.markdown-body .markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-danger-fg);
}
</style><title>README</title></head><body><article class="markdown-body"><h1><a id="user-content-homework-from-suse" class="anchor" aria-hidden="true" tabindex="-1" href="#homework-from-suse"><span aria-hidden="true" class="octicon octicon-link"></span></a>Homework from SUSE</h1>
<p>Project: 2401-OVMF</p>
<p>Version: 1.0</p>
<p>Released Date: 2024/1/27</p>
<p>Table of Contents</p>
<ul>
<li>Questions</li>
<li>Answers
<ul>
<li>Q1 - Compiling OVMF by GCC and Linux tool chain (mandatory)</li>
<li>Q2 - What's the limitation of maximum CPU number in EDK2? (optional)</li>
</ul>
</li>
<li>Source Tree
<ul>
<li>Files in Top</li>
<li>[documents]</li>
<li>[external]</li>
<li>[images]</li>
<li>[patch]</li>
<li>[build]</li>
</ul>
</li>
<li>Building Process
<ul>
<li>Machines</li>
<li>Process 1 - Prove EDK2 Workable</li>
<li>Process 2 - Build OVMF</li>
<li>Process 3 - Trace Max CPU Number</li>
</ul>
</li>
<li>Trace Code
<ul>
<li>[OvmfPkg]</li>
<li>[OvmfPkg/PlatformPei]</li>
<li>[OvmfPkg/Library/PlatformInitLib]</li>
<li>[OvmfPkg/Include/IndustryStandard]</li>
<li>[OvmfPkg/Library/QemuFwCfgLib]</li>
<li>[OvmfPkg/Include/Library]</li>
<li>[UefiCpuPkg/CpuMpPei]</li>
<li>[UefiCpuPkg/Library/MpInitLib]</li>
<li>[MdePkg/Library/PeiHobLib]</li>
</ul>
</li>
<li>Experiment
<ul>
<li>[images/edk2-2308-ovmf2]</li>
<li>Run QEMU/OVMF with Debug Messages</li>
<li>MpTest3.efi</li>
<li>Try Limitation of Hob</li>
<li>[images/edk2-2308-ovmf]</li>
<li>Run QEMU/OVMF with One CPU</li>
<li>Run QEMU/OVMF with Two CPUs</li>
<li>MpTest2.efi</li>
</ul>
</li>
<li>Conclusion</li>
<li>Log
<ul>
<li>2024/1/22</li>
<li>2024/1/23</li>
<li>2024/1/24</li>
<li>2024/1/25</li>
<li>2024/1/26</li>
</ul>
</li>
</ul>
<h1><a id="user-content-questions" class="anchor" aria-hidden="true" tabindex="-1" href="#questions"><span aria-hidden="true" class="octicon octicon-link"></span></a>Questions</h1>
<p>One topic is mandatory, and one is optional. Please send those two topics
to candidate:</p>
<p><strong>Q1: Compiling OVMF by GCC and Linux tool chain (mandatory)</strong></p>
<p>Please explain the process for how to compiling OVMF by GCC and Linux tool
chain. Candidate can use edk2-stable202308 or edk2-stable202311 version from
edk2 git. Architecture: x86-64</p>
<p><strong>Q2: What's the limitation of maximum CPU number in EDK2? (optional)</strong></p>
<p>This is an optional topic. If candidate still have time after the mandatory
topic is finished. Please trace the open source code of EDK2/OVMF to find
out the limitation of maximum CPU number in EDK2.</p>
<p>Candidate should comments part of source code in their tracing reports in order
to elaborate the meanings and behaviors that codes could have. Please write down
your <em>English</em> report in plain text format [.txt] or any other open source format
you prefer.</p>
<p>In this homework, we need you to focus on x86-64 and refer to the following
repos and branches:</p>
<ul>
<li>edk2-stable202108 verion tag on EDK2/OVMF git:
<a href="https://github.com/tianocore/edk2.git">https://github.com/tianocore/edk2.git</a>
</li>
</ul>
<p>Please trace them in one week as deep as you can and then send your report to
us in order to trigger the next-stage interview.</p>
<h1><a id="user-content-answers" class="anchor" aria-hidden="true" tabindex="-1" href="#answers"><span aria-hidden="true" class="octicon octicon-link"></span></a>Answers</h1>
<h2><a id="user-content-q1---compiling-ovmf-by-gcc-and-linux-tool-chain-mandatory" class="anchor" aria-hidden="true" tabindex="-1" href="#q1---compiling-ovmf-by-gcc-and-linux-tool-chain-mandatory"><span aria-hidden="true" class="octicon octicon-link"></span></a>Q1 - Compiling OVMF by GCC and Linux tool chain (mandatory)</h2>
<p>I summarize the process to build OVMF followed the requirements of the question, Q1.</p>
<ol>
<li>Check out EDK2 source tree. <a href="https://github.com/tianocore/edk2.git">https://github.com/tianocore/edk2.git</a>
</li>
<li>Select the version <strong>edk2-stable202308</strong> rather than <strong>edk2-stable202311</strong> beause I suppose the old version has more resources than the new one.</li>
<li>Prepare machines for the process. One is named <strong>Builder</strong>, and another is named <strong>Runner</strong>.</li>
<li>Use Sublime Text to create the project 2401-OVMF with a source tree, and used sftp-config.json to automatically synchronize files between <strong>Builder</strong> and <strong>Runner</strong>
</li>
<li>Built Docker images to prepare EDK2 environment, build OVMF package, develop UEFI applications for automatically fast try and error.</li>
<li>Ask ChatGPT and Google when suffering problem.</li>
</ol>
<p>The detail of the process is described in <strong>Source Tree</strong> and <strong>Building Process</strong> chapters.</p>
<h2><a id="user-content-q2---whats-the-limitation-of-maximum-cpu-number-in-edk2-optional" class="anchor" aria-hidden="true" tabindex="-1" href="#q2---whats-the-limitation-of-maximum-cpu-number-in-edk2-optional"><span aria-hidden="true" class="octicon octicon-link"></span></a>Q2 - What's the limitation of maximum CPU number in EDK2? (optional)</h2>
<p>The limitation of maximum CPU number in EDK2 is 2728. It is the answer of Q2. The reason is:</p>
<ul>
<li>The limitation of the data length in Hob restricts the number.</li>
<li>HobLib.c <code>ASSERT (DataLength &lt;= (0xFFF8 - sizeof (EFI_HOB_GUID_TYPE)));</code>
</li>
</ul>
<p>In EDK2, the PcdCpuMaxLogicalProcessorNumber PCD defines maximum CPU number. But in QEMU, there is another mechanism to define the number.</p>
<ul>
<li>The mechanism is QEMU Firmware Configuration</li>
<li>The default is one. We can chagne the number by -smp option by running qemu-system-x86_64. E.g., <code>-smp 2</code>
</li>
<li>if <code>-smp 256</code>, QEMU displays the error message <code>qemu-system-x86_64: Invalid SMP CPUs 256. The max CPUs supported by machine 'pc-i440fx-8.2' is 255</code>.</li>
</ul>
<p>The detail of Q2's answer is described in the <strong>Trace Code</strong> and <strong>Experiment</strong> chapters.</p>
<h1><a id="user-content-source-tree" class="anchor" aria-hidden="true" tabindex="-1" href="#source-tree"><span aria-hidden="true" class="octicon octicon-link"></span></a>Source Tree</h1>
<p>The source tree, 2401-OVMF, is used to build EDK2/OVMF and to help answer Q1 and Q2. The "2401" in the name means "January, 2024" to indicate the year/month of the project beginning.</p>
<p>Below is the source tree:</p>
<pre><code>[2401-OVMF]
    README.md 
    README.html

    [documents]

    [external]
        [edk2]
        [MpTest1]
        Makefile
    
    [images]
        [edk2-2308] 
            Dockerfile
            Makefile
        [edk2-2308-emu]     
            Dockerfile
            Makefile        
        [edk2-2308-app]
            Dockerfile
            Makefile   
        [edk2-2308-ovmf]   
            Dockerfile
            Makefile        
        [edk2-2308-ovmf2]   
            Dockerfile
            Makefile  
    [patch]
        [edk2-2308-app]
            [MdeModulePkg]
                [Application]
                    [HelloWorld]
                        HelloWorld.c
                    [MpTest]
                        MpTest.c
                        MpTest.inf
                    [MpTest2]
                        MpTest2.c
                        MpTest2.inf
                    [MpTest3]
                        MpTest3.c
                        MpTest3.inf
                MdeModulePkg.dsc
        [edk2-2308-ovmf2]
            [OvmfPkg]
                OvmfPkgX64.dsc
            [UefiCpuPkg]
                [Library]
                    [MpInitLib]
                        MpLib.c
                        PeiMpLib.c
    [build]
</code></pre>
<h2><a id="user-content-files-in-top" class="anchor" aria-hidden="true" tabindex="-1" href="#files-in-top"><span aria-hidden="true" class="octicon octicon-link"></span></a>Files in Top</h2>
<p>README.md</p>
<ul>
<li>This is the file itself in Markdown format.</li>
</ul>
<p>README.html</p>
<ul>
<li>This is the README file in HTML format.</li>
</ul>
<h2><a id="user-content-documents" class="anchor" aria-hidden="true" tabindex="-1" href="#documents"><span aria-hidden="true" class="octicon octicon-link"></span></a>[documents]</h2>
<ul>
<li>The directory contains documents and pictures.</li>
</ul>
<h2><a id="user-content-external" class="anchor" aria-hidden="true" tabindex="-1" href="#external"><span aria-hidden="true" class="octicon octicon-link"></span></a>[external]</h2>
<p>The directory contains all source code from GitHub repositories and from websites. The files in it are read-only.</p>
<p>The purpose of the directory is:</p>
<ol>
<li>To be a source of development.</li>
<li>To trace source code.</li>
</ol>
<p>The following are subdirectories and files, and we can read Makefile to find the clues of them.</p>
<pre><code>[edk2]
[MpTest1]
Makefile
</code></pre>
<p>Makefile</p>
<pre><code>#
# The below targets are run in the builder machine.
#

pull-1:
	git clone https://github.com/tianocore/edk2.git

pull-2:
	cd edk2 &amp;&amp; \
	git checkout edk2-stable202308 &amp;&amp; \
	git submodule update --init

#
# MPTest1 is got from https://www.lab-z.com/mpscpu/
#
</code></pre>
<h2><a id="user-content-images" class="anchor" aria-hidden="true" tabindex="-1" href="#images"><span aria-hidden="true" class="octicon octicon-link"></span></a>[images]</h2>
<p>The directory generates Docker images to prepare EDK2 environment, build OVMF package, and develop UEFI applications.</p>
<p>The purpose of the directory is:</p>
<ol>
<li>To isolate the building process from my machines environment.</li>
<li>To improve the speed of the project completion especially suffering  try-end-error many times.</li>
<li>To easily deliver the tasks to coleagues or release final production.</li>
</ol>
<p>The following are subdirectories and files:</p>
<pre><code>[edk2-2308] 
    Dockerfile
    Makefile
[edk2-2308-emu]     
    Dockerfile
    Makefile        
[edk2-2308-app]
    Dockerfile
    Makefile 
[edk2-2308-ovmf]   
    [esp]
        HelloWorld.efi
        MpTest.efi
        MpTest2.efi
        MpTest3.efi        
    Dockerfile
    Makefile        
[edk2-2308-ovmf2]   
    [esp]
        HelloWorld.efi
        MpTest.efi
        MpTest2.efi
        MpTest3.efi        
    Dockerfile
    Makefile   
</code></pre>
<p>[edk2-2308]</p>
<ul>
<li>The directory is used to build the Docker Image, edk2-2308.</li>
<li>It is an origin image that can derive other images (E.g., edk2-2308-app, edk2-2308-emu, edk2-2308-ovmf, and edk2-2308-ovmf2.</li>
<li>The image contains EDK2 of the edk2-stable202308 version.</li>
<li>The image prepares EDK2 tool chain that has been built.</li>
<li>The Docker and Makefile files has details of the directory. The details are skiped here.</li>
</ul>
<p>[edk2-2308-emu]</p>
<ul>
<li>The directory is used to build the Docker Image, edk2-2308-emu.</li>
<li>The image is derived from edk2-2308.</li>
<li>The image contains EDK2 of the edk2-stable202308 version.</li>
<li>The image has built EmulatorPkg.</li>
<li>The image is used to proof that the edk2-stable202308 version is workable.</li>
<li>The Docker and Makefile files has details of the directory. The details are skiped here.</li>
</ul>
<p>[edk2-2308-app]</p>
<ul>
<li>The directory is used to build the Docker Image, edk2-2308-app.</li>
<li>The image is derived from edk2-2308.</li>
<li>The image contains EDK2 of the edk2-stable202308 version.</li>
<li>The image is used to develop UEFI applications.</li>
<li>HelloWorld.efi, MpTest.efi, and MpTest2.efi have been built.</li>
<li>The Docker and Makefile files has details of the directory. The details are skiped here.</li>
</ul>
<p>[edk2-2308-ovmf]</p>
<ul>
<li>The directory is used to build the Docker Image, edk2-2308-ovmf.</li>
<li>The image is derived from edk2-2308.</li>
<li>The image contains EDK2 of the edk2-stable202308 version.</li>
<li>The image has standard OvmfPkg that has been built.</li>
<li>The directory [esp] contains UEFI applications (HelloWorld.efi, MpTest.efi, and MpTest2.efi) that are generated by edk2-2308-app and are run in UEFI shell in the QEMU/OVMF environment.</li>
<li>The Docker and Makefile files has details of the directory. The details are skiped here.</li>
</ul>
<p>[edk2-2308-ovmf2]</p>
<ul>
<li>The directory is used to build the Docker Image, edk2-2308-ovmf2.</li>
<li>The image is derived from edk2-2308.</li>
<li>The image contains EDK2 of the edk2-stable202308 version.</li>
<li>The image is used to customize OvmfPkg to add debug messages.</li>
<li>We deliver the executable OvmfPkg in QEMU to observe debug log for the Q2 question.</li>
<li>The directory [esp] contains UEFI applications same as esp in [edk2-2308-ovmf]</li>
<li>The Docker and Makefile files has details of the directory. The details are skiped here.</li>
</ul>
<p>Images dependency:</p>
<pre><code>edk2-2308 &lt;--- edk2-2308-emu
          &lt;--- edk2-2308-app
          &lt;--- edk2-2308-ovmf
          &lt;--- edk2-2308-ovmf2
</code></pre>
<h2><a id="user-content-patch" class="anchor" aria-hidden="true" tabindex="-1" href="#patch"><span aria-hidden="true" class="octicon octicon-link"></span></a>[patch]</h2>
<p>The directory contains patched files to override the original files from [external] directory.</p>
<p>The [patch/edk2-2308-app] directory is the patch of edk2-2308-app image.</p>
<p>The [patch/edk2-2308-ovmf2] directory is the patch of edk2-2308-ovmf2 image.</p>
<p>We can open the below Makefile to understand how to use the patches.</p>
<p>[images/edk2-2308-app]</p>
<p>Makefile</p>
<pre><code>BUILDER_HOME = ~/work/2401-OVMF
IMG = edk2-2308-app
RUNER_HOME = /Users/visualge/Dropbox/CodeGit/2401-OVMF

#
# The below targets are run in the builder machine.
#

pre:
	mkdir -p build
	cp -r ${BUILDER_HOME}/patch/edk2-2308-app/ build/edk2/

d-build:
	docker build -t ${IMG} .

... ...
</code></pre>
<p>The <strong>pre</strong> target builds the [build] directory and copy the [edk2-2308-app] patch under the [build/edk2] directory that is under the [images/edk2-2308-app].</p>
<p>The <strong>d-build</strong> target builds the Docker image, edk2-2308-app by the below Dockerfile.</p>
<p>[images/edk2-2308-app]</p>
<p>Dockerfile</p>
<pre><code>FROM edk2-2308 as base

#
# Patch files.
#

COPY build/edk2/ /work/edk2/
</code></pre>
<p>The command <strong>COPY</strong> copies the native [build/edk2] directory to the Docker container [/work/edk2] directory.</p>
<p>[images/edk2-2308-ovmf2]</p>
<ul>
<li>Makefile
<ul>
<li>The mechanism is samed as one in [images/edk2-2308-app]</li>
</ul>
</li>
<li>Dockerfile
<ul>
<li>The mechanism is samed as one in [images/edk2-2308-app]</li>
</ul>
</li>
</ul>
<h2><a id="user-content-build" class="anchor" aria-hidden="true" tabindex="-1" href="#build"><span aria-hidden="true" class="octicon octicon-link"></span></a>[build]</h2>
<p>The directory contains files output from Docker containers.</p>
<h1><a id="user-content-building-process" class="anchor" aria-hidden="true" tabindex="-1" href="#building-process"><span aria-hidden="true" class="octicon octicon-link"></span></a>Building Process</h1>
<p><a target="_blank" rel="noopener noreferrer" href="/Users/visualge/Dropbox/CodeGit/2401-OVMF/documents/1.jpg"><img src="/Users/visualge/Dropbox/CodeGit/2401-OVMF/documents/1.jpg" alt="Building Process" style="max-width: 100%;"></a></p>
<p>The picture describes the building process of the OVMF homework. There are two machines (Builder and Runer), 3 processes with 10+ steps. Those are described below.</p>
<h2><a id="user-content-machines" class="anchor" aria-hidden="true" tabindex="-1" href="#machines"><span aria-hidden="true" class="octicon octicon-link"></span></a>Machines</h2>
<p>Builder</p>
<ul>
<li>The machine provides environment to prepare Docker images of EDK2.</li>
</ul>
<p>Runner</p>
<ul>
<li>The machine provides environment to run QEMU/OVMF.</li>
</ul>
<h2><a id="user-content-process-1---prove-edk2-workable" class="anchor" aria-hidden="true" tabindex="-1" href="#process-1---prove-edk2-workable"><span aria-hidden="true" class="octicon octicon-link"></span></a>Process 1 - Prove EDK2 Workable</h2>
<p>The steps in the process are in Builder.</p>
<ol>
<li>Clone EDK2 from edk2.git @ GitHub in the [external/edk2] directory.</li>
</ol>
<p>[2401-OVMF/external]</p>
<pre><code>$ make pull-1
</code></pre>
<ol start="2">
<li>Check out the edk2-stable202308 version.</li>
</ol>
<p>[2401-OVMF/external]</p>
<pre><code>$ make pull-2
</code></pre>
<ol start="3">
<li>Build edk2-2308 image.</li>
</ol>
<p>[2401-OVMF/images/edk2-2308]</p>
<pre><code>$ make d-rm
$ make clean
$ make pre
$ make d-build
$ make d-run-d
$ make d-exec
</code></pre>
<ol start="4">
<li>Build edk2-2308-emu image derived from edk2-2308 image.</li>
</ol>
<p>[2401-OVMF/images/edk2-2308-emu]</p>
<pre><code>$ make d-rm
$ make clean
$ make d-build
$ make d-run-d
$ make d-exec
</code></pre>
<h2><a id="user-content-process-2---build-ovmf" class="anchor" aria-hidden="true" tabindex="-1" href="#process-2---build-ovmf"><span aria-hidden="true" class="octicon octicon-link"></span></a>Process 2 - Build OVMF</h2>
<p>The steps in the process are involved in Builder and Runner. If a machine is not mentioned in a step, the default is Builder.</p>
<ol start="5">
<li>Build edk2-2308-ovmf image derived from edk2-2308 image.</li>
</ol>
<p>[2401-OVMF/images/edk2-2308-ovmf]</p>
<pre><code>$ make d-rm
$ make clean
$ make d-build
$ make d-run-d
$ make d-exec
</code></pre>
<ol start="6">
<li>Copy the produced OvmfX64 directory from the edk2-2308-ovmf container to the natvie [build/OvmfX64] directory.</li>
</ol>
<p>[2401-OVMF/images/edk2-2308-ovmf]</p>
<pre><code>$ make cp-from-docker
</code></pre>
<ol start="7">
<li>In Runner, remote copy the directory from Builder's [build/OvmfX86] to the native [build/OvmfX86], and run QEMU/OVMF.</li>
</ol>
<p>[2401-OVMF/images/edk2-2308-ovmf]</p>
<pre><code>$ make cp-from-builder
$ make run-ovmf
</code></pre>
<h2><a id="user-content-process-3---trace-max-cpu-number" class="anchor" aria-hidden="true" tabindex="-1" href="#process-3---trace-max-cpu-number"><span aria-hidden="true" class="octicon octicon-link"></span></a>Process 3 - Trace Max CPU Number</h2>
<p>The steps in the process are involved in Builder and Runner. If a machine is not mentioned in a step, the default is Builder.</p>
<ol start="8">
<li>Copy [patch/edk2-2308-app] that contains source code of HelloWorld, MpTest, and MpTest1 to [images/edk2-2308-app/build]</li>
</ol>
<p>[2401-OVMF/images/edk2-2308-app]</p>
<pre><code>$ make pre
</code></pre>
<ol start="9">
<li>Build edk2-2308-app image derived from edk2-2308 image.</li>
</ol>
<p>[2401-OVMF/images/edk2-2308-app]</p>
<pre><code>$ make d-rm
$ make clean
$ make d-build
$ make d-run-d
$ make d-exec
</code></pre>
<ol start="10">
<li>Copy the produced MdeModule directory from the edk2-2308-app container to the natvie [build/MdeModule] directory.</li>
</ol>
<p>[2401-OVMF/images/edk2-2308-app]</p>
<pre><code>$ make cp-from-docker
</code></pre>
<ol start="11">
<li>In Runner, remote copy the directory from Builder's [build/MdeModule] to the native [esp]</li>
</ol>
<p>[2401-OVMF/images/edk2-2308-app]</p>
<pre><code>$ make cp-from-builder
</code></pre>
<p>[2401-OVMF/images/edk2-2308-ovmf]</p>
<pre><code>$ make pre-esp
</code></pre>
<ol start="12">
<li>In Runner, Launch QEMU/OVMF with [esp] and manually run MpTest2.efi in it..</li>
</ol>
<p>[2401-OVMF/images/edk2-2308-ovmf]</p>
<pre><code>$ make run-ovmf-app
$ make run-ovmf-2-app
</code></pre>
<h1><a id="user-content-trace-code" class="anchor" aria-hidden="true" tabindex="-1" href="#trace-code"><span aria-hidden="true" class="octicon octicon-link"></span></a>Trace Code</h1>
<p>The chapter traces source code of EDKII to expain the Q2 question (maximun CPU number).</p>
<p>Maximum CPU number in EDK2:</p>
<ul>
<li>The PcdCpuMaxLogicalProcessorNumber PCD defined maximum CPU number in a DSC file.</li>
<li>The limitation of the data length in Hob restricts the number. The limitation of maximum CPU number is 2728.</li>
</ul>
<p>Maximum CPU number in QEMU.</p>
<ul>
<li>QEMU Firmware Configuration specifies the number.</li>
<li>The default is one. We can chagne the number by -smp option.</li>
<li>The maximum of the option is 255.</li>
</ul>
<p>The below picture describes the dependency of UEFI software components in the executable OVMF with timeline from PEI to DXE to help us trace source code about the Q2 question.
<a target="_blank" rel="noopener noreferrer" href="/Users/visualge/Dropbox/CodeGit/2401-OVMF/documents/3.jpg"><img src="/Users/visualge/Dropbox/CodeGit/2401-OVMF/documents/3.jpg" alt="Dependency" style="max-width: 100%;"></a></p>
<p>The picture has three scopes: OVMF, EDK2 and Test.</p>
<p>OVMF Scope</p>
<ul>
<li>It contains software components: PlatformPei, PlatformInitLib, and QemuFwCfgLib</li>
<li>Those components are provided by OvmfPkg that is OVMF package.</li>
</ul>
<p>EDK2 Scope</p>
<ul>
<li>It contains software components: CpuMpPei, CpuDxe, and MpInitLib</li>
<li>Those components are provided by EDK2 standard pckages, MdePkg and UefiCpuPkg.</li>
</ul>
<p>Test Scope</p>
<ul>
<li>It contains software components: MpTest2, MpTest3</li>
<li>Thouse components are provided by me for the Q2 question.</li>
</ul>
<p>The picture has two phases in timeline from left to right: PEI ---&gt; DXE.</p>
<p>Components are also run sequentially from left to right:</p>
<pre><code>PlatformPei ---&gt; CpuMpPei ---&gt; CpuDxe ---&gt; MpTest2 
                                      ---&gt; MpTest3
</code></pre>
<p>PEI Phase</p>
<ul>
<li>PlatformPei PEI Driver
<ul>
<li>It is provided by OvmfPkg.</li>
<li>It reads a maximum CPU number from the PcdCpuMaxLogicalProcessorNumber PCD.</li>
<li>If QEMU frimware configuration is available, it reads a new maximum CPU number from the config to override the old one, and also updates the PcdCpuMaxLogicalProcessorNumber PCD.</li>
<li>It creates a Hob of the gUefiOvmfPkgPlatformInfoGuid GUID with the EFI_HOB_PLATFORM_INFO structure to store the CPU number. The Hob is owned by OVMF, not by EDK2.</li>
</ul>
</li>
<li>CpuMpPei PEI Driver
<ul>
<li>It is provided by UefiCpuPkg.</li>
<li>It reads the PcdCpuMaxLogicalProcessorNumber PCD to get maximum CPU numbers.</li>
<li>It builds a Hob of MP_HANDOFF_GUID that contains CPUs information.</li>
<li>It appends the Hob in Hob list.</li>
</ul>
</li>
</ul>
<p>DXE Phase</p>
<ul>
<li>CpuDxe DXE Driver
<ul>
<li>It reads the Hob of MP_HANDOFF_GUID to create the EFI_MP_SERVICES_PROTOCOL protocol.</li>
<li>It installs the protocol.</li>
</ul>
</li>
<li>MpTest2 UEFI Application
<ul>
<li>It consums the EFI_MP_SERVICES_PROTOCOL protocol and the EFI_HOB_PLATFORM_INFO Hob to report CPU numbers and some of QEMU firmware configurations.</li>
</ul>
</li>
<li>MpTest3 UEFI Application
<ul>
<li>It doesn't consums any protocols and Hobs.</li>
<li>It calculates the limitation of maximum CPU number.</li>
</ul>
</li>
</ul>
<h2><a id="user-content-ovmfpkg" class="anchor" aria-hidden="true" tabindex="-1" href="#ovmfpkg"><span aria-hidden="true" class="octicon octicon-link"></span></a>[OvmfPkg]</h2>
<p>OvmfPkgX64.dsc</p>
<pre><code>  # UefiCpuPkg PCDs related to initial AP bringup and general AP management.
  gUefiCpuPkgTokenSpaceGuid.PcdCpuMaxLogicalProcessorNumber|64
  gUefiCpuPkgTokenSpaceGuid.PcdCpuBootLogicalProcessorNumber|0
</code></pre>
<p>The maximun CPU number is defined by the PcdCpuMaxLogicalProcessorNumber PCD as 64.</p>
<h2><a id="user-content-ovmfpkgplatformpei" class="anchor" aria-hidden="true" tabindex="-1" href="#ovmfpkgplatformpei"><span aria-hidden="true" class="octicon octicon-link"></span></a>[OvmfPkg/PlatformPei]</h2>
<p>Platform.c:300</p>
<pre><code>EFI_STATUS
EFIAPI
InitializePlatform (
  IN       EFI_PEI_FILE_HANDLE  FileHandle,
  IN CONST EFI_PEI_SERVICES     **PeiServices
  )
{
  PlatformInfoHob = BuildPlatformInfoHob ();
  ...
  PlatformInfoHob-&gt;DefaultMaxCpuNumber = PcdGet32 (PcdCpuMaxLogicalProcessorNumber);

  MaxCpuCountInitialization (PlatformInfoHob);
}
</code></pre>
<p>The PEI driver entry function, InitializePlatform, initializes the platform. It calls MaxCpuCountInitialization() to get max CPU numbers.</p>
<p>Platform.c:259</p>
<pre><code>VOID
MaxCpuCountInitialization (
  IN OUT EFI_HOB_PLATFORM_INFO  *PlatformInfoHob
  )
{
  RETURN_STATUS  PcdStatus;

  PlatformMaxCpuCountInitialization (PlatformInfoHob);

  PcdStatus = PcdSet32S (PcdCpuBootLogicalProcessorNumber, PlatformInfoHob-&gt;PcdCpuBootLogicalProcessorNumber);
  ASSERT_RETURN_ERROR (PcdStatus);
  PcdStatus = PcdSet32S (PcdCpuMaxLogicalProcessorNumber, PlatformInfoHob-&gt;PcdCpuMaxLogicalProcessorNumber);
  ASSERT_RETURN_ERROR (PcdStatus);
}
</code></pre>
<p>The function calls PlatformMaxCpuCountInitialization() to assign max CPU number in PlatformInfoHob.</p>
<h2><a id="user-content-ovmfpkglibraryplatforminitlib" class="anchor" aria-hidden="true" tabindex="-1" href="#ovmfpkglibraryplatforminitlib"><span aria-hidden="true" class="octicon octicon-link"></span></a>[OvmfPkg/Library/PlatformInitLib]</h2>
<p>Platform.c:552</p>
<pre><code>VOID
EFIAPI
PlatformMaxCpuCountInitialization (
  IN OUT EFI_HOB_PLATFORM_INFO  *PlatformInfoHob
  )
{
  UINT16  BootCpuCount = 0;
  UINT32  MaxCpuCount;
  if (QemuFwCfgIsAvailable ()) {
    QemuFwCfgSelectItem (QemuFwCfgItemSmpCpuCount);
    BootCpuCount = QemuFwCfgRead16 ();
  }

  if (BootCpuCount == 0) {
    MaxCpuCount = PlatformInfoHob-&gt;DefaultMaxCpuNumber;
  } else {
    ...
    PlatformCpuCountBugCheck (&amp;BootCpuCount, &amp;Present, &amp;Possible);
    MaxCpuCount = Possible;
  }
  ... ...
  PlatformInfoHob-&gt;PcdCpuMaxLogicalProcessorNumber  = MaxCpuCount;
  PlatformInfoHob-&gt;PcdCpuBootLogicalProcessorNumber = BootCpuCount;
}
</code></pre>
<ul>
<li>The function calls QemuFwCfgIsAvailable() that is returned 1 if launch QEMU.</li>
<li>The BootCpuCount is read from QEMU firmware configuration by I/O access routines (QemuFwCfgSelectItem() and QemuFwCfgRead16()).</li>
<li>The function updates the two PCDs in the HOB.</li>
</ul>
<h2><a id="user-content-ovmfpkgincludeindustrystandard" class="anchor" aria-hidden="true" tabindex="-1" href="#ovmfpkgincludeindustrystandard"><span aria-hidden="true" class="octicon octicon-link"></span></a>[OvmfPkg/Include/IndustryStandard]</h2>
<p>QemuFwCfg.h:50</p>
<pre><code>typedef enum {
  ...
  QemuFwCfgItemSmpCpuCount        = 0x0005,
  ...
}
</code></pre>
<p>The QemuFwCfgItemSmpCpuCount enumerated value defines max CPU number in QEMU firmware configuration.</p>
<h2><a id="user-content-ovmfpkglibraryqemufwcfglib" class="anchor" aria-hidden="true" tabindex="-1" href="#ovmfpkglibraryqemufwcfglib"><span aria-hidden="true" class="octicon octicon-link"></span></a>[OvmfPkg/Library/QemuFwCfgLib]</h2>
<p>QemuFwCfgPei.c:51</p>
<pre><code>BOOLEAN
EFIAPI
QemuFwCfgIsAvailable (
  VOID
  )
{
  return InternalQemuFwCfgIsAvailable ();
}
</code></pre>
<p>The function calls InternalQemuFwCfgIsAvailable() that is returned 1.</p>
<p>QemuFwCfgPei.c:142</p>
<pre><code>BOOLEAN
InternalQemuFwCfgIsAvailable (
  VOID
  )
{
  EFI_HOB_PLATFORM_INFO  *PlatformInfoHob = QemuFwCfgGetPlatformInfo ();

  return PlatformInfoHob-&gt;QemuFwCfgSupported;
}
</code></pre>
<p>The function calls get QemuFwCfgGetPlatformInfo to update/get PlatformInfoHob and returned QemuFwCfgSupported that is 1.</p>
<p>QemuFwCfgPei.c:96</p>
<pre><code>STATIC
EFI_HOB_PLATFORM_INFO *
QemuFwCfgGetPlatformInfo (
  VOID
  )
{
  ...
  if (!PlatformInfoHob-&gt;QemuFwCfgChecked) {
    QemuFwCfgProbe (
      &amp;PlatformInfoHob-&gt;QemuFwCfgSupported,
      &amp;PlatformInfoHob-&gt;QemuFwCfgDmaSupported
      );
    PlatformInfoHob-&gt;QemuFwCfgChecked = TRUE;
  }
  ...
}
</code></pre>
<ul>
<li>The function checks QemuFwCfgChecked. <strong>The value of QemuFwCfgChecked should be FALSE.</strong>
</li>
<li>The function calls QemuFwCfgProbe to get QemuFwCfgSupported anb QemuFwCfgDmaSupported.</li>
<li>The function assigns QemuFwCfgChecked as TRUE.</li>
</ul>
<p>QemuFwCfgPei.c:60</p>
<pre><code>STATIC
VOID
QemuFwCfgProbe (
  BOOLEAN  *Supported,
  BOOLEAN  *DmaSupported
  )
{
  IoWrite16 (FW_CFG_IO_SELECTOR, (UINT16)QemuFwCfgItemSignature);
  IoReadFifo8 (FW_CFG_IO_DATA, sizeof Signature, &amp;Signature);
  IoWrite16 (FW_CFG_IO_SELECTOR, (UINT16)QemuFwCfgItemInterfaceVersion);
  IoReadFifo8 (FW_CFG_IO_DATA, sizeof Revision, &amp;Revision);
  ...
  *Supported    = FALSE;
  *DmaSupported = FALSE;
  if ((Signature == SIGNATURE_32 ('Q', 'E', 'M', 'U')) &amp;&amp; (Revision &gt;= 1)) {
    *Supported = TRUE;
    if ((Revision &amp; FW_CFG_F_DMA) &amp;&amp; !CcGuest) {
      *DmaSupported = TRUE;
    }
  }
  ...
}
</code></pre>
<ul>
<li>The function get Signature and Revision of QEMU firmware configuration by calling I/O access routines.</li>
<li>The function returned Supported that is TRUE.</li>
</ul>
<h2><a id="user-content-ovmfpkgincludelibrary" class="anchor" aria-hidden="true" tabindex="-1" href="#ovmfpkgincludelibrary"><span aria-hidden="true" class="octicon octicon-link"></span></a>[OvmfPkg/Include/Library]</h2>
<p>PlatformInitLib.h:15</p>
<pre><code>typedef struct {
  ...
  UINT32               PcdCpuBootLogicalProcessorNumber;
  UINT32               PcdCpuMaxLogicalProcessorNumber;
  UINT32               DefaultMaxCpuNumber;
  ...
  BOOLEAN              QemuFwCfgChecked;
  BOOLEAN              QemuFwCfgSupported;
  BOOLEAN              QemuFwCfgDmaSupported;
} EFI_HOB_PLATFORM_INFO;
</code></pre>
<ul>
<li>The header file defines HOB variables about max CPU number and QEMU firmware configuration supported.</li>
</ul>
<h2><a id="user-content-ueficpupkgcpumppei" class="anchor" aria-hidden="true" tabindex="-1" href="#ueficpupkgcpumppei"><span aria-hidden="true" class="octicon octicon-link"></span></a>[UefiCpuPkg/CpuMpPei]</h2>
<p>CpuMpPei.c:553</p>
<pre><code>EFI_STATUS
InitializeCpuMpWorker (
  IN CONST EFI_PEI_SERVICES  **PeiServices
  )
{
  ...
  
  Status = MpInitLibInitialize ();
  ...
  Status = PeiServicesInstallPpi (mPeiCpuMpPpiList);
}
</code></pre>
<ul>
<li>The function calls MpInitLibInitialize().</li>
<li>The function calls PeiServicesInstallPpi() to install the mPeiCpuMpPpiList PPI.</li>
</ul>
<h2><a id="user-content-ueficpupkglibrarympinitlib" class="anchor" aria-hidden="true" tabindex="-1" href="#ueficpupkglibrarympinitlib"><span aria-hidden="true" class="octicon octicon-link"></span></a>[UefiCpuPkg/Library/MpInitLib]</h2>
<p>MpLib.c:1985</p>
<pre><code>EFI_STATUS
EFIAPI
MpInitLibInitialize (
  VOID
  )
{
  ...
  MpHandOff = GetMpHandOffHob ();
  if (MpHandOff == NULL) {
    MaxLogicalProcessorNumber = PcdGet32 (PcdCpuMaxLogicalProcessorNumber);
  } else {
    MaxLogicalProcessorNumber = MpHandOff-&gt;CpuCount;
  }
</code></pre>
<ul>
<li>The function reads MaxLogicalProcessorNumber from PCD when it is firstly called.</li>
<li>The function reads MaxLogicalProcessorNumber from Hob when it is secondly called.</li>
</ul>
<pre><code>  ...
  CpuMpData = (CPU_MP_DATA *)(ApIdtBase + VolatileRegisters.Idtr.Limit + 1);
  ...
  CpuMpData-&gt;CpuInfoInHob = (UINT64)(UINTN)
                            (CpuMpData-&gt;CpuData + MaxLogicalProcessorNumber);
</code></pre>
<ul>
<li>Use the CpuMpData pointer to indicate CPU_MP_DATA data from the ApIdtBase address.</li>
<li>Use the CpuMpData-&gt;CpuInfoInHob pointer to indicate CPU information by jump bytes of sizeof(CPU_MP_DATA) * MaxLogicalProcessorNumber from the CpuMpData-&gt;CpuData address.</li>
</ul>
<pre><code>  ...
  ASSERT (
    (CpuMpData-&gt;CpuInfoInHob + sizeof (CPU_INFO_IN_HOB) * MaxLogicalProcessorNumber)
    == (UINTN)MpBuffer + BufferSize - (ApStackSize - Buffer + (UINTN)MpBuffer));
  ...
  if (MpHandOff == NULL) {
    if (MaxLogicalProcessorNumber &gt; 1) {
      //
      // Wakeup all APs and calculate the processor count in system
      //
      CollectProcessorCount (CpuMpData);
    }
  } else {
  }
</code></pre>
<ul>
<li>If the function is firstly called, MpHandOff is NULL.
<ul>
<li>If MaxLogicalProcessorNumber &gt;= 2, it calls CollectProcessorCount() to wakeup all APs as the comment and calculate CPU count.</li>
</ul>
</li>
</ul>
<pre><code>  ...
  InitMpGlobalData (CpuMpData);
}
</code></pre>
<ul>
<li>It calls InitMpGlobalData() to build a Hob for CpuMpData.</li>
</ul>
<p>MpLib.c:1956</p>
<pre><code>MP_HAND_OFF *
GetMpHandOffHob (
  VOID
  )
{
  EFI_HOB_GUID_TYPE  *GuidHob;
  MP_HAND_OFF        *MpHandOff;

  MpHandOff = NULL;
  GuidHob   = GetFirstGuidHob (&amp;mMpHandOffGuid);
  if (GuidHob != NULL) {
    MpHandOff = (MP_HAND_OFF *)
                GET_GUID_HOB_DATA (GuidHob);
  }

  return MpHandOff;
}
</code></pre>
<ul>
<li>The function gets MP_HAND_OFF from Hob list.</li>
<li>If MP_HAND_OFF is not in Hob list, return NULL.</li>
</ul>
<p>MpLib.c:505</p>
<pre><code>UINTN
CollectProcessorCount (
  IN CPU_MP_DATA  *CpuMpData
  )
{
  ...
  //
  // Send 1st broadcast IPI to APs to wakeup APs
  //
  CpuMpData-&gt;InitFlag = ApInitConfig;
  WakeUpAP (CpuMpData, TRUE, 0, NULL, NULL, TRUE);
  CpuMpData-&gt;InitFlag = ApInitDone;
  ...
  CpuMpData-&gt;CpuCount = CpuMpData-&gt;FinishedCount + 1;
  ASSERT (CpuMpData-&gt;CpuCount &lt;= PcdGet32 (PcdCpuMaxLogicalProcessorNumber));
  ...
}
</code></pre>
<ul>
<li>The function is called by BSP to wake up APs.
<ul>
<li>BSP: Bootstrap Processor</li>
<li>AP: Application Processor</li>
</ul>
</li>
<li>The FinishedCount means the number of APs that are woken up.</li>
<li>CpuCount = FinishedCount (the APs) + 1 (the BSP itself)</li>
</ul>
<p>PeiMpLib.c:438</p>
<pre><code>VOID
InitMpGlobalData (
  IN CPU_MP_DATA  *CpuMpData
  )
{
  EFI_STATUS  Status;

  BuildMicrocodeCacheHob (CpuMpData);
  SaveCpuMpData (CpuMpData);

  ///
  /// Install Notify
  ///
  Status = PeiServicesNotifyPpi (&amp;mS3SmmInitDoneNotifyDesc);
  ASSERT_EFI_ERROR (Status);
}
</code></pre>
<ul>
<li>The function calls BuildMicrocodeCacheHob() and  SaveCpuMpData() to build Hobs to store information about CpuMpData.</li>
</ul>
<p>PeiMpLib.c:124</p>
<pre><code>VOID
SaveCpuMpData (
  IN CPU_MP_DATA  *CpuMpData
  )
{
  CpuInfoInHob  = (CPU_INFO_IN_HOB *)(UINTN)CpuMpData-&gt;CpuInfoInHob;
  MpHandOffSize = sizeof (MP_HAND_OFF) + 
                  sizeof (PROCESSOR_HAND_OFF) * CpuMpData-&gt;CpuCount;
  MpHandOff = (MP_HAND_OFF *)BuildGuidHob (&amp;mMpHandOffGuid, MpHandOffSize);
  ASSERT (MpHandOff != NULL);
  ZeroMem (MpHandOff, MpHandOffSize);
  MpHandOff-&gt;ProcessorIndex = 0;

  MpHandOff-&gt;CpuCount = CpuMpData-&gt;CpuCount;
  ...
  //
  // Build location of CPU MP DATA buffer in HOB
  //
  Data64 = (UINT64)(UINTN)CpuMpData;
  BuildGuidDataHob (
    &amp;mCpuInitMpLibHobGuid,
    (VOID *)&amp;Data64,
    sizeof (UINT64)
    );
}
</code></pre>
<ul>
<li>The function save CpuMpData in Hobs: mMpHandOffGuid and mCpuInitMpLibHobGuid.</li>
<li>It calls BuildGuidHob() to build the Hob MpHandOff to store CpuMpData.</li>
<li>It calls BuildGuidDataHob() to build the Hob of mCpuInitMpLibHobGuid as comment.</li>
</ul>
<h2><a id="user-content-mdepkglibrarypeihoblib" class="anchor" aria-hidden="true" tabindex="-1" href="#mdepkglibrarypeihoblib"><span aria-hidden="true" class="octicon octicon-link"></span></a>[MdePkg/Library/PeiHobLib]</h2>
<p>HobLib.c:405</p>
<pre><code>VOID *
EFIAPI
BuildGuidHob (
  IN CONST EFI_GUID  *Guid,
  IN UINTN           DataLength
  )
{
  EFI_HOB_GUID_TYPE  *Hob;

  //
  // Make sure Guid is valid
  //
  ASSERT (Guid != NULL);

  //
  // Make sure that data length is not too long.
  //
  ASSERT (DataLength &lt;= (0xFFF8 - sizeof (EFI_HOB_GUID_TYPE)));

  Hob = InternalPeiCreateHob (EFI_HOB_TYPE_GUID_EXTENSION, 
        (UINT16)(sizeof (EFI_HOB_GUID_TYPE) + DataLength));
  if (Hob == NULL) {
    return Hob;
  }

  CopyGuid (&amp;Hob-&gt;Name, Guid);
  return Hob + 1;
}
</code></pre>
<ul>
<li>The function creates a Hob with DataLength bytes.</li>
<li>The ASSERT is used to ensure that DataLength is at most 65504 bytes.
<ul>
<li>0xFFF8 - sizeof (EFI_HOB_GUID_TYPE) = 65504 (bytes)
<ul>
<li>sizeof (EFI_HOB_GUID_TYPE) = 24 (bytes)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1><a id="user-content-experiment" class="anchor" aria-hidden="true" tabindex="-1" href="#experiment"><span aria-hidden="true" class="octicon octicon-link"></span></a>Experiment</h1>
<h2><a id="user-content-imagesedk2-2308-ovmf2" class="anchor" aria-hidden="true" tabindex="-1" href="#imagesedk2-2308-ovmf2"><span aria-hidden="true" class="octicon octicon-link"></span></a>[images/edk2-2308-ovmf2]</h2>
<p>We use the edk2-2308-ovmf2 image to customize OvmfPkg with debug messages so that we can observe the maximum CPU number in PEI phase.</p>
<p>We can use the targets to observe it.</p>
<p>[2401-OVMF/images/edk2-2308-ovmf]</p>
<p>Makefile</p>
<pre><code>run-ovmf-d:
  qemu-system-x86_64 \
  -drive file=${RUNER_HOME}/build/edk2-2308-ovmf2/OvmfX64/DEBUG_GCC5/FV/OVMF.fd,if=pflash,format=raw \
  -vga std \
  -net none \
  -debugcon file:debug.log \
  -global isa-debugcon.iobase=0x402

run-ovmf-2-d:
  qemu-system-x86_64 \
  -drive file=${RUNER_HOME}/build/edk2-2308-ovmf2/OvmfX64/DEBUG_GCC5/FV/OVMF.fd,if=pflash,format=raw \
  -vga std \
  -net none \
  -smp 2 \
  -debugcon file:debug.log \
  -global isa-debugcon.iobase=0x402 

run-ovmf-255-d:
  qemu-system-x86_64 \
  -drive file=${RUNER_HOME}/build/edk2-2308-ovmf2/OvmfX64/DEBUG_GCC5/FV/OVMF.fd,if=pflash,format=raw \
  -vga std \
  -net none \
  -smp 255 \
  -debugcon file:debug.log \
  -global isa-debugcon.iobase=0x402 

run-ovmf-256-d:
  qemu-system-x86_64 \
  -drive file=${RUNER_HOME}/build/edk2-2308-ovmf2/OvmfX64/DEBUG_GCC5/FV/OVMF.fd,if=pflash,format=raw \
  -vga std \
  -net none \
  -smp 256 \
  -debugcon file:debug.log \
  -global isa-debugcon.iobase=0x402   

run-ovmf-app:
  qemu-system-x86_64 \
  -drive file=${RUNER_HOME}/build/edk2-2308-ovmf2/OvmfX64/DEBUG_GCC5/FV/OVMF.fd,if=pflash,format=raw \
  -vga std \
  -net none \
  -drive file=fat:rw:esp,index=0,format=vvfat
</code></pre>
<p>The run-ovmf-d target:</p>
<ul>
<li>Run QEMU with debug messages that are saved in debug.log.</li>
</ul>
<p>The run-ovmf-2-d target:</p>
<ul>
<li>Run QEMU with debug messages that are saved in debug.log.</li>
<li>The QEMU enables two CPUs.</li>
</ul>
<p>The run-ovmf-255-d target:</p>
<ul>
<li>Run QEMU with debug messages that are saved in debug.log.</li>
<li>The QEMU enables 255 CPUs.</li>
</ul>
<p>The run-ovmf-256-d target:</p>
<ul>
<li>Run QEMU with debug messages that are saved in debug.log</li>
<li>The QEMU enables 256 CPUs.</li>
</ul>
<p>The run-ovmf-app target:</p>
<ul>
<li>The QEMU uses the esp directory as a file system named FS0.</li>
<li>We can put our UEFI Application files (e.g., MpTest2.efi and MpTest3.efi) in the directory, and run them at UEFI Shell in the QEMU/OVMF environment.</li>
</ul>
<h2><a id="user-content-run-qemuovmf-with-debug-messages" class="anchor" aria-hidden="true" tabindex="-1" href="#run-qemuovmf-with-debug-messages"><span aria-hidden="true" class="octicon octicon-link"></span></a>Run QEMU/OVMF with Debug Messages</h2>
<p>[2401-OVMF/images/edk2-2308-ovmf]</p>
<pre><code>% make run-ovmf-d
</code></pre>
<p>debug.log</p>
<pre><code>...
Loading PEIM at 0x00000834FC0 EntryPoint=0x0000083CBD3 PlatformPei.efi
...
Loading PEIM at 0x00007EC9000 EntryPoint=0x00007ECD958 CpuMpPei.efi
...
Notify: PPI Guid: F894643D-C449-42D1-8EA8-85BDD8C65BDE, Peim notify entry point: 7ED3407
...
@2018: MaxLogicalProcessorNumber = 1
@2024: MaxLogicalProcessorNumber = 1
...
GetMicrocodePatchInfoFromHob: Microcode patch cache HOB is not found.
CPU[0000]: Microcode revision = 00000000, expected = 00000000
...
@142: CpuCount = 1
@145: MP_HAND_OFF = 16
@146: PROCESSOR_HAND_OFF = 24
@147: MpHandOffSize = 40
@148: EFI_HOB_GUID_TYPE = 24
...
Loading driver at 0x00006CFD000 EntryPoint=0x00006D0203B CpuDxe.efi
ConvertPages: failed to find range FD00000000 - FFFFFFFFFF
...
@2020: MaxLogicalProcessorNumber = 1
@2024: MaxLogicalProcessorNumber = 1
</code></pre>
<p>Observation:</p>
<ul>
<li>The order of UEFI PEI/DXE driver running is PlatformPei.efi ---&gt; CpuMpPei.efi ---&gt; and  CpuDxe.efi</li>
<li>MaxLogicalProcessorNumber is assigned twice by calling MpInitLibInitialize() twice. CpuMpPei.efi calls MpInitLibInitialize() and CpuDxe.efi calls it again.</li>
<li>CpuCount = 1 means that the PEI driver detects 1 CPU and saves CPU info with 40 (MpHandOffSize) bytes in a Hob.</li>
<li>The system can boot the UEFI shell.</li>
</ul>
<pre><code>% make run-ovmf-2-d
</code></pre>
<p>debug.log</p>
<pre><code>     @2018: MaxLogicalProcessorNumber = 2
     @2024: MaxLogicalProcessorNumber = 2

     @528: CpuMpData-&gt;CpuCount = 2
     @529: PcdCpuMaxLogicalProcessorNumber  = 2
     
     @142: CpuCount = 2
     @145: MP_HAND_OFF = 16
     @146: PROCESSOR_HAND_OFF = 24
     @147: MpHandOffSize = 64
     @148: EFI_HOB_GUID_TYPE = 24

     @2020: MaxLogicalProcessorNumber = 2
     @2024: MaxLogicalProcessorNumber = 2
</code></pre>
<p>Observation:</p>
<ul>
<li>The message @528 means that CollectProcessorCount() is called to wakeup all APs.</li>
<li>CpuCount = 2 means that the PEI driver detects two CPUs and saves CPUs info with 64 (MpHandOffSize) bytes in a Hob.</li>
<li>The system can boot the UEFI shell.</li>
</ul>
<pre><code>% make run-ovmf-255-d
</code></pre>
<p>debug.log</p>
<pre><code>     @2018: MaxLogicalProcessorNumber = 255
     @2024: MaxLogicalProcessorNumber = 255

     @528: CpuMpData-&gt;CpuCount = 255
     @529: PcdCpuMaxLogicalProcessorNumber  = 255     

     @142: CpuCount = 255
     @145: MP_HAND_OFF = 16
     @146: PROCESSOR_HAND_OFF = 24
     @147: MpHandOffSize = 6136
     @148: EFI_HOB_GUID_TYPE = 24

     @2020: MaxLogicalProcessorNumber = 255
     @2024: MaxLogicalProcessorNumber = 255     
</code></pre>
<p>Observation:</p>
<ul>
<li>The message @528 means that CollectProcessorCount() is called to wakeup all APs.</li>
<li>CpuCount = 255 means that the PEI driver detects 255 CPUs and saves CPUs info with 6136 (MpHandOffSize) bytes in a Hob.</li>
<li>The system can boot the UEFI shell.</li>
</ul>
<pre><code>% make run-ovmf-256-d
qemu-system-x86_64: Invalid SMP CPUs 256. The max CPUs supported by machine 'pc-i440fx-8.2' is 255
</code></pre>
<p>Observation:</p>
<ul>
<li>The system hangs because the limitation of max CPU number supported by QEMU is 255.</li>
</ul>
<pre><code>% make run-ovmf-app
</code></pre>
<p>[QEMU/OVMF UEFI Shell]</p>
<pre><code>Shell&gt; FS0:
FS0:&gt; MpTest3.efi
MpTest3..........
MpHandOffSize        : 10h (16) 
ProcessorHandOffSize : 18h (24)
HobGuidTypeSize      : 18h (24)

MaxDataLength : FFE0h (65504)
MaxCpuCount   : AA8h (2728)
</code></pre>
<p>Observation:</p>
<ul>
<li>Use MpTest3.efi to calculate the maximum data length of a Hob is 65504 bytes.</li>
<li>It restricts the limitation of maximum CPU number is 2728.</li>
</ul>
<h2><a id="user-content-mptest3efi" class="anchor" aria-hidden="true" tabindex="-1" href="#mptest3efi"><span aria-hidden="true" class="octicon octicon-link"></span></a>MpTest3.efi</h2>
<p>The MpTest3.efi calculates the limitation of maximum CPU number in Hob.</p>
<p>[2401-OVMF/patch/edk2-2308-app/MdeModulePkg/Application/MpTest3]</p>
<p>MpTest3.c</p>
<pre><code>...
EFI_STATUS
EFIAPI
UefiMain (
  IN EFI_HANDLE        ImageHandle,
  IN EFI_SYSTEM_TABLE  *SystemTable
  )
{
  UINTN MpHandOffSize;
  UINTN ProcessorHandOffSize;
  UINTN HobGuidTypeSize;
  UINTN MaxDataLength;
  UINTN MaxCpuCount;

  Print (L"MpTest3..........\n");

  MpHandOffSize = sizeof(MP_HAND_OFF);
  ProcessorHandOffSize = sizeof(PROCESSOR_HAND_OFF);  
  HobGuidTypeSize = sizeof(EFI_HOB_GUID_TYPE);

  Print(L"MpHandOffSize        : %xh (%d)\n", MpHandOffSize, MpHandOffSize);
  Print(L"ProcessorHandOffSize : %xh (%d)\n", ProcessorHandOffSize, ProcessorHandOffSize);
  Print(L"HobGuidTypeSize      : %xh (%d)\n", HobGuidTypeSize, HobGuidTypeSize);
  Print(L"\n");

  //
  // MaxDataLength = 0xFFF8 - HobGuidTypeSize
  //

  MaxDataLength = 0XFFF8 - HobGuidTypeSize;
  Print(L"MaxDataLength : %xh (%d)\n", MaxDataLength, MaxDataLength);

  //
  // MaxDataLength = MpHandOffSize + ProcessorHandOffSize * MaxCpuCount
  // MaxCpuCount = (MaxDataLength - MpHandOffSize) / ProcessorHandOffSize
  //

  MaxCpuCount = (MaxDataLength - MpHandOffSize) / ProcessorHandOffSize;
  Print(L"MaxCpuCount   : %xh (%d)\n", MaxCpuCount, MaxCpuCount);

  return EFI_SUCCESS;
}
</code></pre>
<h2><a id="user-content-try-limitation-of-hob" class="anchor" aria-hidden="true" tabindex="-1" href="#try-limitation-of-hob"><span aria-hidden="true" class="octicon octicon-link"></span></a>Try Limitation of Hob</h2>
<p>[2401-OVMF/patch/edk2-2308-ovmf2/UefiCpuPkg/Library/MpInitLib]</p>
<p>PeiMpLib.c</p>
<pre><code>VOID
SaveCpuMpData (
  IN CPU_MP_DATA  *CpuMpData
  )
{
  ...
  CpuMpData-&gt;CpuCount = 2278;
  DEBUG ((DEBUG_INFO, "142: CpuCount = %d\n", CpuMpData-&gt;CpuCount)); // Count
</code></pre>
<pre><code>% make run-ovmf-d
</code></pre>
<p>debug.log</p>
<pre><code>@2018: MaxLogicalProcessorNumber = 1
@2024: MaxLogicalProcessorNumber = 1

@142: CpuCount = 2728
@145: MP_HAND_OFF = 16
@146: PROCESSOR_HAND_OFF = 24
@147: MpHandOffSize = 65488
@148: EFI_HOB_GUID_TYPE = 24

@2020: MaxLogicalProcessorNumber = 2728
@2024: MaxLogicalProcessorNumber = 2728
ASSERT /work/edk2/UefiCpuPkg/Library/MpInitLib/MpLib.c(2054): MpBuffer != ((void *) 0)
</code></pre>
<p>Observation:</p>
<ul>
<li>CpuCount = 2728 means that the PEI driver detects 2728 CPUs and saves CPUs info with 65488 (MpHandOffSize) bytes in a Hob.</li>
<li>The system hangs on MpLib.c(2054) because there is not enough memory to allocate a buffer to store AP stacks.</li>
</ul>
<p>PeiMpLib.c</p>
<pre><code>VOID
SaveCpuMpData (
  IN CPU_MP_DATA  *CpuMpData
  )
{
  ...
  CpuMpData-&gt;CpuCount = 2279;
  DEBUG ((DEBUG_INFO, "142: CpuCount = %d\n", CpuMpData-&gt;CpuCount)); // Count
</code></pre>
<pre><code>% make run-ovmf-d
</code></pre>
<p>debug.log</p>
<pre><code>@2018: MaxLogicalProcessorNumber = 1
@2024: MaxLogicalProcessorNumber = 1

@142: CpuCount = 2729
@145: MP_HAND_OFF = 16
@146: PROCESSOR_HAND_OFF = 24
@147: MpHandOffSize = 65512
@148: EFI_HOB_GUID_TYPE = 24
ASSERT /work/edk2/MdePkg/Library/PeiHobLib/HobLib.c(422): DataLength &lt;= (0xFFF8 - sizeof (EFI_HOB_GUID_TYPE))
</code></pre>
<p>Observation:</p>
<ul>
<li>CpuCount = 2729 means that the PEI driver detects 2729 CPUs and wants to save CPUs info with 65512 (MpHandOffSize) bytes in a Hob.</li>
<li>The system hangs on HobLib.c(422) because the data length of a hob is at most 65504 bytes. The data length, 65512 (MpHandOffSize) bytes, is out of the range.</li>
</ul>
<h2><a id="user-content-imagesedk2-2308-ovmf" class="anchor" aria-hidden="true" tabindex="-1" href="#imagesedk2-2308-ovmf"><span aria-hidden="true" class="octicon octicon-link"></span></a>[images/edk2-2308-ovmf]</h2>
<p>We can use the two targets run-ovmf-app and run-ovmf-2-app to test the CPU number in QEMU/OVMF environment.</p>
<p>[2401-OVMF/images/edk2-2308-ovmf]</p>
<p>Makefile</p>
<pre><code>run-ovmf-app:
  qemu-system-x86_64 \
  -drive file=${RUNER_HOME}/build/OvmfX64/DEBUG_GCC5/FV/OVMF.fd,if=pflash,format=raw \
  -vga std \
  -net none \
  -drive file=fat:rw:esp,index=0,format=vvfat

run-ovmf-2-app:
  qemu-system-x86_64 \
  -drive file=${RUNER_HOME}/build/OvmfX64/DEBUG_GCC5/FV/OVMF.fd,if=pflash,format=raw \
  -vga std \
  -net none \
  -drive file=fat:rw:esp,index=0,format=vvfat \
  -smp 2
</code></pre>
<h2><a id="user-content-run-qemuovmf-with-one-cpu" class="anchor" aria-hidden="true" tabindex="-1" href="#run-qemuovmf-with-one-cpu"><span aria-hidden="true" class="octicon octicon-link"></span></a>Run QEMU/OVMF with One CPU</h2>
<p>[2401-OVMF/images/edk2-2308-ovmf]</p>
<pre><code>% make run-ovmf-app
</code></pre>
<p>[QEMU/OVMF UEFI Shell]</p>
<pre><code>Shell&gt; FS0:
FS0:&gt; MpTest2.efi
MpTest..........
Number of Processors 1
Number of Enabled Processors 1
Report CPU numbers from PlatformInfoHob.
MaxCpuCount           = 1
BootCpuCount          = 1
DefaultMaxCpuCount    = 64
QemuFwCfgChecked      = 1
QemuFwCfgSupported    = 1
QemuFwCfgDmaSupported = 1
</code></pre>
<h2><a id="user-content-run-qemuovmf-with-two-cpus" class="anchor" aria-hidden="true" tabindex="-1" href="#run-qemuovmf-with-two-cpus"><span aria-hidden="true" class="octicon octicon-link"></span></a>Run QEMU/OVMF with Two CPUs</h2>
<p>[2401-OVMF/images/edk2-2308-ovmf]</p>
<pre><code>% make run-ovmf-2-app
</code></pre>
<p>[QEMU/OVMF UEFI Shell]</p>
<pre><code>Shell&gt; FS0:
FS0:&gt; MpTest2.efi
MpTest..........
Number of Processors 2
Number of Enabled Processors 2
Report CPU numbers from PlatformInfoHob.
MaxCpuCount           = 2
BootCpuCount          = 2
DefaultMaxCpuCount    = 64
QemuFwCfgChecked      = 1
QemuFwCfgSupported    = 1
QemuFwCfgDmaSupported = 1
</code></pre>
<h2><a id="user-content-mptest2efi" class="anchor" aria-hidden="true" tabindex="-1" href="#mptest2efi"><span aria-hidden="true" class="octicon octicon-link"></span></a>MpTest2.efi</h2>
<p>The MpTest2.efi consumes HOB and EFI_MP_SERVICES_PROTOCOL to get CPU numbers and a part of QEMU firmware configuration.</p>
<p>[2401-OVMF/patch/edk2-2308-app/MdeModulePkg/Application/MpTest2]</p>
<p>MpTest2.c</p>
<pre><code>EFI_STATUS
EFIAPI
UefiMain (
  IN EFI_HANDLE        ImageHandle,
  IN EFI_SYSTEM_TABLE  *SystemTable
  )
{
  EFI_STATUS Status;
  EFI_MP_SERVICES_PROTOCOL *Mp = NULL;
  UINTN NumProcessors;
  UINTN NumberOfEnabledProcessors;  
  //EFI_HOB_GENERIC_HEADER *CurrentHob;
  EFI_HOB_GUID_TYPE      *GuidHob;
  EFI_HOB_PLATFORM_INFO *PlatformInfoHob;  
  UINT32 MaxCpuCount;
  UINT32 BootCpuCount;
  UINT32 DefaultMaxCpuCount;
  BOOLEAN QemuFwCfgChecked;
  BOOLEAN QemuFwCfgSupported;
  BOOLEAN QemuFwCfgDmaSupported;

  Print (L"MpTest..........\n");

  //
  // Locate MP_Service Protocol
  //

  Status = gBS-&gt;LocateProtocol(&amp;gEfiMpServiceProtocolGuid, NULL, (VOID**)&amp;Mp);
  if (EFI_ERROR (Status)) {
    Print(L"Unable to initialize MP protocol interface!");
    return EFI_UNSUPPORTED;
  }  

  //
  // Determine number of processors
  //

  Status = Mp-&gt;GetNumberOfProcessors(Mp, &amp;NumProcessors , &amp;NumberOfEnabledProcessors);
  if (EFI_ERROR(Status)) {
    Print( L"Mp-&gt;GetNumEnabledProcessors(): Unable to determine number of processors.\n") ;
    return EFI_UNSUPPORTED;
  }

  //
  // Report the processors.
  //

  Print(L"Number of Processors %d\n", NumProcessors);
  Print(L"Number of Enabled Processors %d\n", NumberOfEnabledProcessors);  

  //
  // Get the start of the HOB List from the system table or DXE services
  //

  GuidHob = GetFirstGuidHob(&amp;gUefiOvmfPkgPlatformInfoGuid);
  if (GuidHob == NULL) {
     Print(L"PlatformInfoHob is not found.\n");
     return EFI_UNSUPPORTED;
  }

  //
  // Report CPU numbers from PlatformInfoHob.
  //

  PlatformInfoHob = (EFI_HOB_PLATFORM_INFO *) GET_GUID_HOB_DATA(GuidHob);

  Print(L"Report CPU numbers from PlatformInfoHob.\n");  

  MaxCpuCount = PlatformInfoHob-&gt;PcdCpuMaxLogicalProcessorNumber;
  BootCpuCount = PlatformInfoHob-&gt;PcdCpuBootLogicalProcessorNumber;
  DefaultMaxCpuCount = PlatformInfoHob-&gt;DefaultMaxCpuNumber;
  QemuFwCfgChecked = PlatformInfoHob-&gt;QemuFwCfgChecked;
  QemuFwCfgSupported = PlatformInfoHob-&gt;QemuFwCfgSupported;
  QemuFwCfgDmaSupported = PlatformInfoHob-&gt;QemuFwCfgDmaSupported;


  Print(L"MaxCpuCount           = %d\n", MaxCpuCount);
  Print(L"BootCpuCount          = %d\n", BootCpuCount);
  Print(L"DefaultMaxCpuCount    = %d\n", DefaultMaxCpuCount);
  Print(L"QemuFwCfgChecked      = %d\n", QemuFwCfgChecked);
  Print(L"QemuFwCfgSupported    = %d\n", QemuFwCfgSupported);
  Print(L"QemuFwCfgDmaSupported = %d\n", QemuFwCfgDmaSupported);

  return EFI_SUCCESS;
}
</code></pre>
<h1><a id="user-content-conclusion" class="anchor" aria-hidden="true" tabindex="-1" href="#conclusion"><span aria-hidden="true" class="octicon octicon-link"></span></a>Conclusion</h1>
<p>I built the 2401-OVMF project to help me answer the two questions: Q1 and Q2.</p>
<p>I described hwo to use the project to build OVMF followed the requirements of the Q1 question.</p>
<p>For the Q2 questions, the limitation of maximum CPU number in EDK2 is 2728. It is the answer of Q2.</p>
<p>I also observed that:</p>
<ol>
<li>In EDK2, although a Hob can store information for 2728 CPUs, the system is still failed to allocate memory space for storing AP stacks.</li>
<li>In EDK2, the PcdCpuMaxLogicalProcessorNumber PCD defines maximum CPU number in a DSC file.</li>
<li>In QEMU, the number is specified by QEMU Firmware Configuration. It overrides the PcdCpuMaxLogicalProcessorNumber PCD.</li>
<li>The default is one. We can chagne the number by -smp option by running qemu-system-x86_64. E.g., <code>-smp 2</code>
</li>
<li>if <code>-smp 256</code>, QEMU/OVMF hangs because the max CPU number supported by QEMU is 255.</li>
<li>if <code>-smp 255</code>, QEMU/OVMF can boot the UEFI shell.</li>
<li>QemuFwCfgChecked and QemuFwCfgSupported are always 1. Therefore QEMU firmware configuration finally decides HOB.</li>
</ol>
<h1><a id="user-content-log" class="anchor" aria-hidden="true" tabindex="-1" href="#log"><span aria-hidden="true" class="octicon octicon-link"></span></a>Log</h1>
<p>2401-OVMF v1.0</p>
<ul>
<li>The version took me <strong>16 hours and 5 miniutes</strong> to complete between 2024/1/22 and 2024/1/24.</li>
</ul>
<p>2401-OVMF v1.1</p>
<ul>
<li>The version took me <strong>10 hours and 51 miniutes</strong> to complete between 2024/1/25 and 2024/1/27.</li>
</ul>
<h2><a id="user-content-2024122" class="anchor" aria-hidden="true" tabindex="-1" href="#2024122"><span aria-hidden="true" class="octicon octicon-link"></span></a>2024/1/22</h2>
<p>Answers of ChatGTP</p>
<ul>
<li><a href="/Users/visualge/Dropbox/CodeGit/2401-OVMF/documents/2024-01-22.html">2024-01-22.html</a></li>
</ul>
<p>Time Log</p>
<pre><code>22:09 - 23:55 106 | $ .
                  | HW - understand 
</code></pre>
<h2><a id="user-content-2024123" class="anchor" aria-hidden="true" tabindex="-1" href="#2024123"><span aria-hidden="true" class="octicon octicon-link"></span></a>2024/1/23</h2>
<p>Answers of ChatGTP</p>
<ul>
<li><a href="/Users/visualge/Dropbox/CodeGit/2401-OVMF/documents/2024-01-23.html">2024-01-23.html</a></li>
</ul>
<p>Time Log</p>
<pre><code>00:04 - 00:44  40 | $ .
                  | Build EmulatorPkg
10:35 - 10:43   7 | $ .
                  | Build OvmfPkg
10:43 - 10:51   8 | $ .
                  | Try QEMU
11:08 - 11:18   9 | $ .
                  | Try QEMU
----------------------------------------
12:38 - 13:02  23 | $ .
                  | Run pre-built OVMF
13:39 - 14:32  53 | $ .
                  | Run pre-built OVMF
14:44 - 15:23  38 | $ .
                  | Run pre-built OVMF
15:30 - 15:30   0 | $ .
                  | Try my built OVMF
15:33 - 15:36   2 | $ .
                  | Try my built OVMF
15:36 - 16:17  41 | $ .
                  | Optimize build process
16:19 - 16:38  18 | $ .
                  | maximum CPU number 
16:38 - 17:33  55 | $ .
                  | Run HelloWorld.efi
17:33 - 17:33   0 | $ .
                  | Imp MpTest.efi
----------------------------------------
18:39 - 20:24 104 | $ .
                  | Imp MpTest.efi
20:24 - 21:32  68 | $ .
                  | Trace OVMF
21:32 - 22:33  61 | $ .
                  | Get QEMU Firmware Configuration
</code></pre>
<h2><a id="user-content-2024124" class="anchor" aria-hidden="true" tabindex="-1" href="#2024124"><span aria-hidden="true" class="octicon octicon-link"></span></a>2024/1/24</h2>
<p>Answers of ChatGTP</p>
<ul>
<li><a href="/Users/visualge/Dropbox/CodeGit/2401-OVMF/documents/2024-01-24.html">2024-01-24.html</a></li>
</ul>
<p>Time Log</p>
<pre><code>----------------------------------------
09:38 - 09:45   6 | $ .
                  | Get QEMU Firmware Configuration
09:45 - 10:57  71 | $ .
                  | write document
11:07 - 13:46 159 | $ .
                  | write document
----------------------------------------
13:48 - 14:44  55 | $ .
                  | write document
14:56 - 15:00   3 | $ .
                  | Arrange ChatGPT
----------------------------------------
18:33 - 18:49  16 | $ .
                  | Arrange ChatGPT
</code></pre>
<h2><a id="user-content-2024125" class="anchor" aria-hidden="true" tabindex="-1" href="#2024125"><span aria-hidden="true" class="octicon octicon-link"></span></a>2024/1/25</h2>
<p>Answers of ChatGTP</p>
<ul>
<li><a href="/Users/visualge/Dropbox/CodeGit/2401-OVMF/documents/2024-01-25.html">2024-01-25.html</a></li>
</ul>
<p>Time Log</p>
<pre><code>----------------------------------------
20:54 - 20:58   4 | $,SUSE .
                  | Read the returned email.
20:59 - 23:05 125 | $,SUSE .
                  | Trace edk2 source code for MaxCpuCount
23:25 - 23:59  33 | $,SUSE .
                  | Implement MpTest3.c
</code></pre>
<h2><a id="user-content-2024126" class="anchor" aria-hidden="true" tabindex="-1" href="#2024126"><span aria-hidden="true" class="octicon octicon-link"></span></a>2024/1/26</h2>
<p>Answers of ChatGTP</p>
<ul>
<li><a href="/Users/visualge/Dropbox/CodeGit/2401-OVMF/documents/2024-01-26.html">2024-01-26.html</a></li>
</ul>
<p>Time Log</p>
<pre><code>----------------------------------------
00:01 - 00:25  24 | $,SUSE .
                  | Implement MpTest3.c
09:59 - 10:23  24 | $,SUSE .
                  | Implement MpTest3.c
10:36 - 12:03  87 | $,SUSE .
                  | Build ovmf2 
----------------------------------------
12:03 - 12:58  55 | $,SUSE .
                  | Try to display debug message in OVMF
----------------------------------------
20:00 - 20:53  52 | $,SUSE .
                  | Draw pictures
20:53 - 23:39 166 | $,SUSE .
                  | Update document
</code></pre>
<h2><a id="user-content-2024127" class="anchor" aria-hidden="true" tabindex="-1" href="#2024127"><span aria-hidden="true" class="octicon octicon-link"></span></a>2024/1/27</h2>
<p>Answers of ChatGTP</p>
<ul>
<li><a href="/Users/visualge/Dropbox/CodeGit/2401-OVMF/documents/2024-01-27.html">2024-01-27.html</a></li>
</ul>
<p>Time Log</p>
<pre><code>----------------------------------------
00:17 - 00:57  40 | $,SUSE .
                  | Update document
01:26 - 01:50  23 | $,SUSE .
                  | Update document
----------------------------------------
13:18 - 13:32  13 | $,SUSE .
                  | Update document
</code></pre>
</article></body></html>